<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Math Invaders</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'Press Start 2P',monospace;color:#fff}
canvas{border:2px solid #0f0;box-shadow:0 0 30px #0f04}
#ui{width:480px;display:flex;justify-content:space-between;padding:8px 4px;font-size:9px;color:#0f0;text-shadow:0 0 8px #0f0}
#questionBar{width:480px;background:#001100;border:2px solid #0f0;padding:12px;text-align:center;font-size:11px;color:#0f0;text-shadow:0 0 8px #0f0;margin-top:4px}
#msg{width:480px;text-align:center;font-size:8px;color:#ff0;height:20px;padding:2px;text-shadow:0 0 6px #ff0}
.overlay{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:10}
.overlay h1{font-size:28px;color:#0f0;text-shadow:0 0 20px #0f0;letter-spacing:4px}
.pixbtn{background:none;border:2px solid #0f0;color:#0f0;font-family:'Press Start 2P',monospace;font-size:10px;padding:12px 28px;cursor:pointer;text-shadow:0 0 8px #0f0;animation:blink 1s step-end infinite}
.pixbtn:hover{background:#0f02}
@keyframes blink{50%{opacity:0}}
</style>
</head>
<body>
<div id="ui"><span>SCORE: <span id="score">0</span></span><span>MATH INVADERS</span><span>LIVES: <span id="lives">3</span></span></div>
<canvas id="c" width="480" height="400"></canvas>
<div id="questionBar">Solve: <span id="qtext">?</span></div>
<div id="msg" id="msg"></div>

<div class="overlay" id="ov">
  <h1>MATH INVADERS</h1>
  <div style="font-size:8px;color:#aaa;text-align:center;line-height:2">Shoot the alien carrying<br>the correct answer!</div>
  <div style="font-size:8px;color:#aaa">← → MOVE &nbsp; SPACE SHOOT</div>
  <button class="pixbtn" onclick="startGame()">PLAY</button>
</div>

<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
const W=480,H=400;
let score=0,lives=3,question={},aliens=[],bullets=[],alienBullets=[],particles=[];
let player={x:240,y:370,w:30,h:20},keys={},gameRunning=false,frameCount=0;
let msg='',msgTimer=0,shootCooldown=0,level=1;
const stars=Array.from({length:80},()=>({x:Math.random()*W,y:Math.random()*H,s:Math.random()+.3}));

function genQ(){
  const ops=['+','-','×'];const op=ops[Math.floor(Math.random()*ops.length)];
  let a,b,ans;
  if(op==='+'){a=Math.floor(Math.random()*20)+1;b=Math.floor(Math.random()*20)+1;ans=a+b;}
  else if(op==='-'){a=Math.floor(Math.random()*20)+10;b=Math.floor(Math.random()*a)+1;ans=a-b;}
  else{a=Math.floor(Math.random()*10)+1;b=Math.floor(Math.random()*10)+1;ans=a*b;}
  return{text:`${a} ${op} ${b} = ?`,answer:ans};
}

function genWrong(correct){
  const wrongs=new Set();
  while(wrongs.size<2){
    let w=correct+Math.floor(Math.random()*10)-5;
    if(w!==correct&&w>0)wrongs.add(w);
  }
  return [...wrongs];
}

function spawnWave(){
  aliens=[];
  question=genQ();
  document.getElementById('qtext').textContent=question.text;
  const wrongs=genWrong(question.answer);
  const answers=[question.answer,...wrongs];
  // shuffle
  for(let i=answers.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[answers[i],answers[j]]=[answers[j],answers[i]];}
  // 3 rows of aliens
  for(let row=0;row<3;row++){
    for(let col=0;col<8;col++){
      aliens.push({
        x:50+col*50,y:50+row*45,w:36,h:28,
        dir:1,speed:.5+level*.1,
        answer: col<3?answers[0]:col<6?answers[1]:answers[2],
        type:row,alive:true,flashTimer:0
      });
    }
  }
}

function shoot(){
  if(shootCooldown>0)return;
  bullets.push({x:player.x,y:player.y-10,vy:-9});
  shootCooldown=18;
}

function explode(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,sp=Math.random()*4+1;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:30,color});
  }
}

function showMsg(text,color='#ff0'){
  msg=text;document.getElementById('msg').textContent=text;
  document.getElementById('msg').style.color=color;msgTimer=80;
}

function update(){
  frameCount++;
  if(shootCooldown>0)shootCooldown--;
  if(msgTimer>0){msgTimer--;if(msgTimer===0)document.getElementById('msg').textContent='';}

  if(keys['ArrowLeft'])player.x=Math.max(20,player.x-4.5);
  if(keys['ArrowRight'])player.x=Math.min(W-20,player.x+4.5);
  if(keys['Space'])shoot();

  // move aliens
  let edge=false;
  const alive=aliens.filter(a=>a.alive);
  alive.forEach(a=>{a.x+=a.dir*a.speed;if(a.x>W-25||a.x<25)edge=true;});
  if(edge){alive.forEach(a=>{a.dir*=-1;a.y+=12;});}

  // alien shoots
  if(frameCount%Math.max(60-level*5,20)===0&&alive.length){
    const shooter=alive[Math.floor(Math.random()*alive.length)];
    alienBullets.push({x:shooter.x,y:shooter.y+14,vy:3+level*.3});
  }

  // move bullets
  bullets=bullets.filter(b=>{b.y+=b.vy;return b.y>-10;});
  alienBullets=alienBullets.filter(b=>{b.y+=b.vy;return b.y<H+10;});

  // bullet-alien collision
  bullets.forEach((b,bi)=>{
    aliens.forEach(a=>{
      if(!a.alive)return;
      if(Math.abs(b.x-a.x)<20&&Math.abs(b.y-a.y)<16){
        bullets.splice(bi,1);
        if(a.answer===question.answer){
          a.alive=false;
          score+=100*level;
          explode(a.x,a.y,'#0f0',16);
          showMsg('CORRECT! +'+100*level,'#0f0');
          document.getElementById('score').textContent=score;
          setTimeout(()=>{if(gameRunning)spawnWave();},1200);
        } else {
          a.flashTimer=20;
          explode(a.x,a.y,'#f00',8);
          showMsg('WRONG! -1 LIFE','#f44');
          lives--;document.getElementById('lives').textContent=lives;
          if(lives<=0)endGame();
        }
      }
    });
  });

  // alien bullet hits player
  alienBullets.forEach((b,bi)=>{
    if(Math.abs(b.x-player.x)<16&&Math.abs(b.y-player.y)<12){
      alienBullets.splice(bi,1);
      explode(player.x,player.y,'#08f');
      lives--;document.getElementById('lives').textContent=lives;
      if(lives<=0)endGame();
    }
  });

  // aliens reach bottom
  if(alive.some(a=>a.y>H-60)){endGame();}

  // particles
  particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.life--;return p.life>0;});
}

function drawAlien(a){
  ctx.save();ctx.translate(a.x,a.y);
  if(a.flashTimer>0){ctx.globalAlpha=.5+.5*Math.sin(a.flashTimer*.8);a.flashTimer--;}
  const colors=['#f44','#f80','#ff0'];
  const c=colors[a.type];
  ctx.shadowBlur=8;ctx.shadowColor=c;ctx.fillStyle=c;
  // cute alien body
  ctx.fillRect(-12,-10,24,16);
  ctx.fillRect(-16,-6,6,10);ctx.fillRect(10,-6,6,10);
  ctx.fillRect(-8,-16,6,8);ctx.fillRect(2,-16,6,8);
  ctx.fillStyle='#000';ctx.fillRect(-8,-6,5,6);ctx.fillRect(3,-6,5,6);
  // answer label
  ctx.fillStyle='#fff';ctx.font='6px Press Start 2P';ctx.textAlign='center';
  ctx.shadowBlur=0;ctx.fillText(a.answer,0,10);
  ctx.restore();
}

function draw(){
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  stars.forEach(s=>{ctx.fillStyle='#fff4';ctx.beginPath();ctx.arc(s.x,s.y,s.s,0,Math.PI*2);ctx.fill();});

  // ground
  ctx.fillStyle='#0f0';ctx.fillRect(0,H-4,W,4);

  // player
  ctx.save();ctx.translate(player.x,player.y);
  ctx.shadowBlur=14;ctx.shadowColor='#0f0';ctx.fillStyle='#0f0';
  ctx.fillRect(-15,-8,30,14);ctx.fillRect(-6,-18,12,12);
  ctx.fillStyle='#0f08';ctx.fillRect(-22,-4,8,8);ctx.fillRect(14,-4,8,8);
  ctx.restore();

  aliens.forEach(a=>{if(a.alive)drawAlien(a);});

  bullets.forEach(b=>{ctx.fillStyle='#0ff';ctx.shadowBlur=8;ctx.shadowColor='#0ff';ctx.fillRect(b.x-2,b.y-6,4,12);});
  alienBullets.forEach(b=>{ctx.fillStyle='#f40';ctx.shadowBlur=6;ctx.shadowColor='#f40';ctx.fillRect(b.x-2,b.y-5,4,10);});

  particles.forEach(p=>{ctx.globalAlpha=p.life/30;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,2,0,Math.PI*2);ctx.fill();});
  ctx.globalAlpha=1;
}

function loop(){if(!gameRunning)return;update();draw();requestAnimationFrame(loop);}

function startGame(){
  document.getElementById('ov').style.display='none';
  score=0;lives=3;level=1;bullets=[];alienBullets=[];particles=[];frameCount=0;gameRunning=true;
  document.getElementById('score').textContent=0;document.getElementById('lives').textContent=3;
  spawnWave();loop();
}

function endGame(){
  gameRunning=false;
  document.getElementById('ov').innerHTML=`<h1 style="color:#f44">GAME OVER</h1><div style="font-size:9px;color:#0f0">SCORE: ${score}</div><button class="pixbtn" onclick="startGame()">RETRY</button>`;
  document.getElementById('ov').style.display='flex';
}

document.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Space')e.preventDefault();});
document.addEventListener('keyup',e=>keys[e.code]=false);

// idle star animation
(function idleLoop(){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);stars.forEach(s=>{ctx.fillStyle='#fff6';ctx.beginPath();ctx.arc(s.x,s.y,s.s,0,Math.PI*2);ctx.fill();});requestAnimationFrame(idleLoop);})();
</script>
</body>
</html>
