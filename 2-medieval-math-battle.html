<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Medieval Math Battle</title>
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0608; overflow: hidden; font-family: 'Crimson Text', serif; }
  canvas { display: block; }

  #ui-overlay {
    position: fixed; inset: 0;
    pointer-events: none;
    z-index: 10;
  }

  /* ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ */
  #start-screen {
    position: fixed; inset: 0;
    background: linear-gradient(180deg, #0a0608 0%, #1a0a14 40%, #0d0a1a 100%);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 100;
    font-family: 'Cinzel', serif;
  }
  #start-screen .title-wrap {
    text-align: center; margin-bottom: 40px;
  }
  #start-screen h1 {
    font-size: clamp(32px, 6vw, 72px);
    font-weight: 900;
    background: linear-gradient(180deg, #f5d76e 0%, #c8960c 50%, #8b6914 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-shadow: none;
    filter: drop-shadow(0 0 30px #f5d76e88);
    letter-spacing: 2px;
    line-height: 1.1;
  }
  #start-screen .subtitle {
    color: #a0856a; font-size: clamp(13px,2vw,18px);
    font-family: 'Crimson Text', serif; font-style: italic;
    margin-top: 8px; letter-spacing: 1px;
  }
  .mode-label {
    color: #f5d76e; font-size: clamp(14px,2vw,20px);
    margin-bottom: 16px; letter-spacing: 2px;
    text-transform: uppercase;
  }
  .mode-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 12px; margin-bottom: 32px;
    width: min(400px, 90vw);
  }
  .mode-btn {
    background: linear-gradient(135deg, #1e1228 0%, #2a1a3a 100%);
    border: 2px solid #4a2e6a;
    border-radius: 8px; padding: 16px 20px;
    color: #c8a8e8; font-family: 'Cinzel', serif;
    font-size: clamp(13px,2vw,16px); font-weight: 700;
    cursor: pointer; pointer-events: all;
    transition: all 0.2s; text-align: center;
    letter-spacing: 1px;
  }
  .mode-btn:hover, .mode-btn.selected {
    background: linear-gradient(135deg, #3a1a5a 0%, #5a2a8a 100%);
    border-color: #c8a8e8; color: #fff;
    box-shadow: 0 0 20px #8a4abf66;
    transform: translateY(-2px);
  }
  .mode-btn .mode-icon { font-size: 24px; display: block; margin-bottom: 4px; }
  .start-btn {
    background: linear-gradient(135deg, #8b4a0c 0%, #c8780c 50%, #f5a020 100%);
    border: none; border-radius: 8px;
    padding: 18px 60px; color: #fff;
    font-family: 'Cinzel', serif; font-size: clamp(16px,2.5vw,22px);
    font-weight: 900; cursor: pointer; pointer-events: all;
    letter-spacing: 3px; text-transform: uppercase;
    box-shadow: 0 0 30px #f5a02066, 0 4px 15px #00000066;
    transition: all 0.2s;
  }
  .start-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 50px #f5a020aa, 0 8px 25px #00000088;
  }
  .start-btn:disabled {
    opacity: 0.4; cursor: not-allowed; transform: none;
  }

  /* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
  #hud {
    position: fixed; top: 0; left: 0; right: 0;
    height: 52px;
    background: linear-gradient(180deg, #0a0608ee 0%, #0a060800 100%);
    display: flex; align-items: center;
    padding: 0 16px; gap: 20px;
    z-index: 20; pointer-events: none;
  }
  .hud-item {
    font-family: 'Cinzel', serif; font-size: 13px;
    color: #f5d76e; letter-spacing: 1px;
    display: flex; align-items: center; gap: 6px;
  }
  .hud-item span { color: #fff; font-weight: 700; }
  #hud-level { font-size: 15px; font-weight: 700; }

  /* ‚îÄ‚îÄ PLACEMENT UI ‚îÄ‚îÄ */
  #placement-ui {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: linear-gradient(0deg, #0a0608ff 0%, #0a060800 100%);
    padding: 8px 16px 12px;
    z-index: 20; display: none;
  }
  #shop-scroll {
    display: flex; gap: 10px; overflow-x: auto;
    padding-bottom: 6px; margin-bottom: 10px;
    scrollbar-width: thin; scrollbar-color: #4a2e6a transparent;
  }
  .shop-unit {
    flex-shrink: 0;
    background: linear-gradient(135deg, #1a1028 0%, #241535 100%);
    border: 2px solid #3a2050;
    border-radius: 8px; padding: 8px 10px;
    cursor: pointer; pointer-events: all;
    text-align: center; min-width: 80px;
    transition: all 0.15s; position: relative;
  }
  .shop-unit:hover:not(.cant-afford) {
    border-color: #c8a8e8;
    box-shadow: 0 0 15px #8a4abf44;
    transform: translateY(-2px);
  }
  .shop-unit.selected { border-color: #f5d76e; box-shadow: 0 0 15px #f5d76e66; }
  .shop-unit.cant-afford { opacity: 0.4; cursor: not-allowed; }
  .shop-unit .unit-icon { font-size: 24px; display: block; }
  .shop-unit .unit-name { font-family: 'Cinzel', serif; font-size: 9px; color: #c8a8e8; letter-spacing: 0.5px; display: block; margin: 2px 0; }
  .shop-unit .unit-cost { font-family: 'Cinzel', serif; font-size: 11px; color: #f5d76e; font-weight: 700; }
  .shop-unit .sell-hint { font-size: 8px; color: #888; display: block; }

  #placement-actions {
    display: flex; gap: 10px; align-items: center; justify-content: center;
    flex-wrap: wrap;
  }
  .action-btn {
    background: linear-gradient(135deg, #1e3a1a 0%, #2a5222 100%);
    border: 2px solid #4a8a42;
    border-radius: 6px; padding: 10px 20px;
    color: #8ad882; font-family: 'Cinzel', serif;
    font-size: 13px; font-weight: 700;
    cursor: pointer; pointer-events: all;
    letter-spacing: 1px; transition: all 0.15s;
  }
  .action-btn:hover { border-color: #8ad882; color: #fff; box-shadow: 0 0 15px #4a8a4244; }
  .action-btn.sell-mode {
    background: linear-gradient(135deg, #3a1a1a 0%, #5a2222 100%);
    border-color: #8a4242; color: #e88282;
  }
  .action-btn.sell-mode:hover { border-color: #e88282; color: #fff; }
  .battle-btn {
    background: linear-gradient(135deg, #8b1a0c 0%, #c82a10 50%, #f54020 100%);
    border: 2px solid #f54020;
    border-radius: 6px; padding: 12px 30px;
    color: #fff; font-family: 'Cinzel', serif;
    font-size: 15px; font-weight: 900;
    cursor: pointer; pointer-events: all;
    letter-spacing: 2px;
    box-shadow: 0 0 20px #f5402044;
    transition: all 0.15s;
  }
  .battle-btn:hover { transform: translateY(-2px); box-shadow: 0 0 35px #f5402088; }

  /* ‚îÄ‚îÄ BATTLE UI ‚îÄ‚îÄ */
  #battle-ui {
    position: fixed; bottom: 0; left: 0; right: 0;
    padding: 10px 16px;
    display: none;
    z-index: 20;
    justify-content: center; gap: 12px; flex-wrap: wrap;
  }
  .powerup-btn {
    pointer-events: all;
    border-radius: 8px; padding: 10px 18px;
    font-family: 'Cinzel', serif; font-size: 13px;
    font-weight: 700; cursor: pointer;
    letter-spacing: 1px; transition: all 0.15s;
    border: 2px solid;
  }
  .powerup-btn.rally {
    background: linear-gradient(135deg, #3a1a0c 0%, #6a2a10 100%);
    border-color: #f5a020; color: #f5a020;
  }
  .powerup-btn.shield {
    background: linear-gradient(135deg, #0c1a3a 0%, #102a6a 100%);
    border-color: #40a0f5; color: #40a0f5;
  }
  .powerup-btn.medic {
    background: linear-gradient(135deg, #0c3a1a 0%, #106a2a 100%);
    border-color: #40f580; color: #40f580;
  }
  .powerup-btn:hover { filter: brightness(1.3); transform: translateY(-2px); }
  .powerup-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: none; }
  .powerup-btn.active { animation: pulse-btn 0.5s ease infinite alternate; }
  @keyframes pulse-btn { from { box-shadow: 0 0 10px currentColor; } to { box-shadow: 0 0 25px currentColor; } }

  /* ‚îÄ‚îÄ MODAL OVERLAY ‚îÄ‚îÄ */
  #modal {
    position: fixed; inset: 0;
    background: #00000099;
    display: none; align-items: center; justify-content: center;
    z-index: 50; backdrop-filter: blur(4px);
  }
  #modal.show { display: flex; }
  .modal-box {
    background: linear-gradient(135deg, #0e0a18 0%, #1a1028 100%);
    border: 2px solid #4a2e6a;
    border-radius: 16px; padding: 32px;
    max-width: min(500px, 94vw); width: 100%;
    font-family: 'Cinzel', serif;
    box-shadow: 0 0 60px #8a4abf44;
    pointer-events: all;
  }
  .modal-box h2 {
    font-size: clamp(20px,4vw,28px); font-weight: 900;
    text-align: center; margin-bottom: 20px;
    background: linear-gradient(180deg, #f5d76e 0%, #c8960c 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 15px #f5d76e66);
  }
  .modal-box .modal-sub {
    text-align: center; color: #a0856a;
    font-family: 'Crimson Text', serif; font-size: 15px;
    margin-bottom: 24px;
  }

  /* Math question styling */
  #math-question {
    text-align: center;
    font-family: 'Cinzel', serif;
    font-size: clamp(22px,5vw,38px);
    color: #fff; margin-bottom: 20px;
    letter-spacing: 2px;
    font-weight: 700;
  }
  #math-input {
    display: block; margin: 0 auto 16px;
    width: 120px; padding: 12px;
    text-align: center; font-size: 28px;
    font-family: 'Cinzel', serif;
    background: #1a1028; color: #f5d76e;
    border: 2px solid #4a2e6a; border-radius: 8px;
    outline: none;
  }
  #math-input:focus { border-color: #f5d76e; box-shadow: 0 0 15px #f5d76e44; }
  .math-submit {
    display: block; margin: 0 auto;
    background: linear-gradient(135deg, #4a2e6a 0%, #8a4abf 100%);
    border: 2px solid #8a4abf;
    border-radius: 8px; padding: 12px 40px;
    color: #fff; font-family: 'Cinzel', serif;
    font-size: 16px; font-weight: 700;
    cursor: pointer; pointer-events: all;
    letter-spacing: 2px;
    transition: all 0.15s;
  }
  .math-submit:hover { box-shadow: 0 0 20px #8a4abf88; transform: translateY(-2px); }
  .math-feedback {
    text-align: center; font-size: 18px;
    margin-top: 12px; min-height: 24px;
    font-family: 'Crimson Text', serif;
  }
  .math-feedback.correct { color: #40f580; }
  .math-feedback.wrong { color: #f54040; }
  .math-progress {
    display: flex; gap: 8px; justify-content: center;
    margin-bottom: 20px;
  }
  .progress-dot {
    width: 14px; height: 14px; border-radius: 50%;
    background: #2a1a3a; border: 2px solid #4a2e6a;
    transition: all 0.3s;
  }
  .progress-dot.done { background: #40f580; border-color: #40f580; }
  .progress-dot.fail { background: #f54040; border-color: #f54040; }

  /* Timer bar */
  #timer-bar-wrap {
    width: 100%; height: 8px;
    background: #2a1a3a; border-radius: 4px;
    margin-bottom: 16px; overflow: hidden;
  }
  #timer-bar {
    height: 100%; width: 100%;
    background: linear-gradient(90deg, #f5a020, #f54020);
    border-radius: 4px;
    transition: width 0.1s linear;
  }
  #timer-text {
    text-align: center; font-family: 'Cinzel', serif;
    font-size: 14px; color: #f5a020;
    margin-bottom: 8px;
  }
  #coin-earned {
    text-align: center; font-family: 'Cinzel', serif;
    font-size: 16px; color: #f5d76e;
    margin-bottom: 12px;
  }

  /* Results screen */
  #results-canvas {
    width: 100%; border-radius: 8px;
    margin: 16px 0;
  }
  .results-row {
    display: flex; justify-content: space-between;
    font-family: 'Crimson Text', serif; font-size: 16px;
    color: #c8a8e8; padding: 4px 0;
    border-bottom: 1px solid #2a1a3a;
  }
  .results-row span { color: #f5d76e; font-weight: 600; }
  .results-continue {
    display: block; margin: 20px auto 0;
    background: linear-gradient(135deg, #1e3a1a 0%, #2a5222 100%);
    border: 2px solid #4a8a42;
    border-radius: 8px; padding: 14px 40px;
    color: #8ad882; font-family: 'Cinzel', serif;
    font-size: 16px; font-weight: 700;
    cursor: pointer; pointer-events: all;
    letter-spacing: 2px; transition: all 0.15s;
  }
  .results-continue:hover { border-color: #8ad882; color: #fff; box-shadow: 0 0 20px #4a8a4266; }

  /* Numpad for touch */
  #numpad {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 8px; margin: 12px auto 0;
    max-width: 240px;
  }
  .num-key {
    background: #1a1028; border: 2px solid #4a2e6a;
    border-radius: 8px; padding: 14px;
    color: #c8a8e8; font-family: 'Cinzel', serif;
    font-size: 20px; font-weight: 700;
    cursor: pointer; pointer-events: all;
    text-align: center; transition: all 0.1s;
    -webkit-tap-highlight-color: transparent;
  }
  .num-key:active { background: #3a2050; border-color: #8a4abf; }
  .num-key.del-key { grid-column: span 2; font-size: 14px; }
  .num-key.sub-key { background: linear-gradient(135deg, #1e3a1a, #2a5222); border-color: #4a8a42; color: #8ad882; }

  /* Game over / win */
  .game-over-box { text-align: center; }
  .game-over-box p { color: #a0856a; font-family: 'Crimson Text', serif; font-size: 16px; margin: 12px 0 24px; }

  /* Touch D-pad overlay */
  #dpad { display: none; }

  /* Active powerup indicator */
  #active-powerups {
    position: fixed; top: 56px; right: 12px;
    display: flex; flex-direction: column; gap: 4px;
    z-index: 20; pointer-events: none;
  }
  .active-pu {
    background: #00000088; border-radius: 6px;
    padding: 4px 10px; font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 1px;
  }
  .active-pu.rally { color: #f5a020; border: 1px solid #f5a02066; }
  .active-pu.shield { color: #40a0f5; border: 1px solid #40a0f566; }
  .active-pu.medic { color: #40f580; border: 1px solid #40f58066; }

  /* Floating text animations */
  @keyframes float-up {
    0% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-60px); }
  }
  .float-txt {
    position: fixed; pointer-events: none;
    font-family: 'Cinzel', serif; font-weight: 700;
    font-size: 18px; z-index: 30;
    animation: float-up 1.2s ease forwards;
  }

  @media (max-width: 600px) {
    #numpad { max-width: 200px; }
    .num-key { padding: 12px; font-size: 18px; }
  }
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="title-wrap">
    <h1>‚öîÔ∏è Medieval<br>Math Battle</h1>
    <div class="subtitle">Command your army. Answer to conquer.</div>
  </div>
  <div class="mode-label">Choose Your Math Mode</div>
  <div class="mode-grid">
    <button class="mode-btn" data-mode="add">
      <span class="mode-icon">‚ûï</span>Addition
    </button>
    <button class="mode-btn" data-mode="sub">
      <span class="mode-icon">‚ûñ</span>Subtraction
    </button>
    <button class="mode-btn" data-mode="mul">
      <span class="mode-icon">‚úñÔ∏è</span>Multiplication
    </button>
    <button class="mode-btn" data-mode="div">
      <span class="mode-icon">‚ûó</span>Division
    </button>
  </div>
  <button class="start-btn" id="start-btn" disabled>‚öîÔ∏è BEGIN CAMPAIGN</button>
</div>

<!-- CANVAS -->
<canvas id="game-canvas"></canvas>

<!-- HUD -->
<div id="hud">
  <div class="hud-item">üè∞ LEVEL <span id="hud-level">1</span></div>
  <div class="hud-item">üí∞ <span id="hud-coins">0</span></div>
  <div class="hud-item" id="hud-units-wrap">‚öîÔ∏è <span id="hud-units">0</span>/16</div>
  <div class="hud-item" style="margin-left:auto;" id="hud-phase"></div>
</div>

<!-- ACTIVE POWERUPS -->
<div id="active-powerups"></div>

<!-- PLACEMENT UI -->
<div id="placement-ui">
  <div id="shop-scroll"></div>
  <div id="placement-actions">
    <button class="action-btn" id="sell-btn">üí∞ Sell Mode</button>
    <button class="action-btn" id="clear-btn">üóëÔ∏è Clear All</button>
    <button class="battle-btn" id="battle-btn">‚öîÔ∏è BATTLE!</button>
  </div>
</div>

<!-- BATTLE UI -->
<div id="battle-ui" style="display:none; position:fixed; bottom:0; left:0; right:0; padding:10px 16px; justify-content:center; gap:12px; flex-wrap:wrap; z-index:20;">
  <button class="powerup-btn rally" id="pu-rally" onclick="requestPowerup('rally')">‚öîÔ∏è Rally (+ATK)</button>
  <button class="powerup-btn shield" id="pu-shield" onclick="requestPowerup('shield')">üõ°Ô∏è Shield Wall (+DEF)</button>
  <button class="powerup-btn medic" id="pu-medic" onclick="requestPowerup('medic')">üíö Field Medic (HEAL)</button>
</div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box" id="modal-box"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUDIO ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AC = new (window.AudioContext || window.webkitAudioContext)();
function resumeAC() { if(AC.state==='suspended') AC.resume(); }
document.addEventListener('touchstart', resumeAC, {once:true});
document.addEventListener('mousedown', resumeAC, {once:true});

function playTone(freq, type='sine', dur=0.15, vol=0.3, delay=0) {
  try {
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    o.type = type; o.frequency.value = freq;
    const t = AC.currentTime + delay;
    g.gain.setValueAtTime(vol, t);
    g.gain.exponentialRampToValueAtTime(0.001, t+dur);
    o.start(t); o.stop(t+dur);
  } catch(e){}
}

function swordClash() {
  playTone(800,'square',0.05,0.2);
  playTone(600,'square',0.08,0.15,0.03);
  playTone(200,'sawtooth',0.1,0.1,0.02);
}
function arrowWhoosh() {
  const o=AC.createOscillator(),g=AC.createGain();
  o.connect(g);g.connect(AC.destination);
  o.type='sawtooth';
  o.frequency.setValueAtTime(1200,AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(300,AC.currentTime+0.15);
  g.gain.setValueAtTime(0.2,AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+0.15);
  o.start();o.stop(AC.currentTime+0.15);
}
function explosion() {
  const buf=AC.createBuffer(1,AC.sampleRate*0.3,AC.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(AC.sampleRate*0.1));
  const s=AC.createBufferSource();s.buffer=buf;
  const g=AC.createGain();s.connect(g);g.connect(AC.destination);
  g.gain.value=0.4;s.start();
}
function coinDing() {
  playTone(880,'sine',0.1,0.3);
  playTone(1320,'sine',0.1,0.2,0.08);
}
function correctSfx() {
  playTone(440,'sine',0.08,0.2);
  playTone(660,'sine',0.08,0.2,0.08);
  playTone(880,'sine',0.12,0.25,0.16);
}
function wrongSfx() {
  playTone(200,'sawtooth',0.15,0.3);
  playTone(180,'sawtooth',0.15,0.2,0.1);
}
function victoryFanfare() {
  [523,659,784,1047].forEach((f,i)=>playTone(f,'square',0.2,0.3,i*0.12));
}
function defeatSound() {
  [400,350,300,200].forEach((f,i)=>playTone(f,'sawtooth',0.2,0.2,i*0.15));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
canvas.style.position = 'fixed';
canvas.style.inset = '0';

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', () => { resizeCanvas(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameState = 'START'; // START, PLACEMENT, BATTLE, MATHSHOP, POWERUP, RESULTS, GAMEOVER, WIN
let mathMode = null;
let level = 1;
let coins = 0;
let checkpoint = 1;
let sellMode = false;
let selectedUnit = null;

// Placed units on grid [row][col] for both sides
// Player grid: 3 rows x 5 cols
const PLAYER_ROWS = 3, PLAYER_COLS = 5;
const MAX_UNITS = 16; // can't exceed 3*5=15 so cap is 15 in practice

let playerGrid = Array.from({length:PLAYER_ROWS}, ()=>Array(PLAYER_COLS).fill(null));

// Battle units (flat arrays with positions/hp/etc)
let battleUnits = []; // all active units during battle
let projectiles = [];
let particles = [];
let floatingTexts = [];

// PowerUps
let activePowerups = { rally: false, shield: false, medic: false };
let powerupPending = null; // which powerup we're challenging for

// Battle history for graph
let battleHistory = []; // {level, playerStart, enemyStart, playerEnd, enemyEnd}

// Persistent unit roster (units that survived previous rounds)
let survivingUnits = []; // [{type, hp, maxHp}] flattened

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNIT DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAYER_UNITS = {
  swordsman:     { name:'Swordsman',    cost:50,  hp:90,  atk:18, def:10, range:65,  speed:60, color:'#4a8aff', accent:'#2a5adf', icon:'‚öîÔ∏è' },
  spearman:      { name:'Spearman',     cost:70,  hp:75,  atk:22, def:8,  range:85,  speed:55, color:'#ff8a4a', accent:'#df5a2a', icon:'üó°Ô∏è' },
  archer:        { name:'Archer',       cost:90,  hp:55,  atk:28, def:3,  range:220, speed:45, color:'#8aff4a', accent:'#5adf2a', icon:'üèπ', isRanged:true },
  crossbow:      { name:'Crossbow',     cost:120, hp:60,  atk:38, def:5,  range:280, speed:40, color:'#cfff4a', accent:'#afdf2a', icon:'üéØ', isRanged:true },
  knight:        { name:'Knight',       cost:180, hp:170, atk:30, def:22, range:70,  speed:50, color:'#c8c8ff', accent:'#9898df', icon:'üõ°Ô∏è' },
  heavyInfantry: { name:'Hvy Infantry', cost:200, hp:220, atk:25, def:30, range:60,  speed:35, color:'#888888', accent:'#666666', icon:'ü™ñ' },
  royalGuard:    { name:'Royal Guard',  cost:260, hp:200, atk:35, def:28, range:70,  speed:45, color:'#ffd700', accent:'#cc9900', icon:'üëë' },
  catapult:      { name:'Catapult',     cost:320, hp:65,  atk:65, def:2,  range:320, speed:20, color:'#8b4513', accent:'#5c2d00', icon:'üí•', isRanged:true, isSiege:true },
  trebuchet:     { name:'Trebuchet',    cost:420, hp:55,  atk:90, def:1,  range:380, speed:15, color:'#6b3513', accent:'#4c2000', icon:'üî•', isRanged:true, isSiege:true }
};

const ENEMY_DEFS = {
  goblinScout:    { name:'Goblin Scout',    hp:45,  atk:10, def:3,  range:60,  speed:70, color:'#4aff4a', accent:'#2adf2a' },
  skeletonWarr:   { name:'Skeleton Warrior',hp:60,  atk:14, def:6,  range:65,  speed:55, color:'#e0e0e0', accent:'#b0b0b0' },
  banditRaider:   { name:'Bandit Raider',   hp:80,  atk:20, def:8,  range:70,  speed:60, color:'#c8a050', accent:'#a07030' },
  orcBrute:       { name:'Orc Brute',       hp:140, atk:28, def:14, range:70,  speed:45, color:'#50c820', accent:'#30a800' },
  armoredTroll:   { name:'Armored Troll',   hp:220, atk:35, def:25, range:75,  speed:30, color:'#708070', accent:'#506050' },
  enemyCatapult:  { name:'Enemy Catapult',  hp:60,  atk:55, def:2,  range:300, speed:15, color:'#8b5513', accent:'#5c3000', isRanged:true, isSiege:true },
  // Bosses
  ogreChief:      { name:'OGRE CHIEF',      hp:500, atk:45, def:20, range:90,  speed:35, color:'#ff6020', accent:'#df4000', isBoss:true },
  shadowWizard:   { name:'SHADOW WIZARD',   hp:380, atk:60, def:10, range:250, speed:40, color:'#8020c0', accent:'#6000a0', isBoss:true, isRanged:true },
  stoneGiant:     { name:'STONE GIANT',     hp:800, atk:55, def:35, range:100, speed:25, color:'#909090', accent:'#606060', isBoss:true },
  dragon:         { name:'THE DRAGON',      hp:1200,atk:80, def:40, range:350, speed:45, color:'#ff2020', accent:'#c00000', isBoss:true, isRanged:true }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEVEL DEFINITIONS (handcrafted)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEVELS = [
  // Level 1-4
  { enemies: [{t:'goblinScout',n:4}] },
  { enemies: [{t:'goblinScout',n:5},{t:'skeletonWarr',n:2}] },
  { enemies: [{t:'goblinScout',n:4},{t:'skeletonWarr',n:4}] },
  { enemies: [{t:'skeletonWarr',n:6},{t:'banditRaider',n:2}] },
  // Level 5 BOSS
  { enemies: [{t:'ogreChief',n:1},{t:'goblinScout',n:4}], boss:true },
  // 6-9
  { enemies: [{t:'banditRaider',n:5},{t:'orcBrute',n:2}] },
  { enemies: [{t:'banditRaider',n:4},{t:'orcBrute',n:4}] },
  { enemies: [{t:'orcBrute',n:5},{t:'skeletonWarr',n:4}] },
  { enemies: [{t:'orcBrute',n:4},{t:'banditRaider',n:4},{t:'enemyCatapult',n:1}] },
  // Level 10 BOSS
  { enemies: [{t:'shadowWizard',n:1},{t:'banditRaider',n:4},{t:'goblinScout',n:4}], boss:true },
  // 11-14
  { enemies: [{t:'armoredTroll',n:3},{t:'orcBrute',n:4}] },
  { enemies: [{t:'armoredTroll',n:4},{t:'enemyCatapult',n:2}] },
  { enemies: [{t:'armoredTroll',n:3},{t:'orcBrute',n:5},{t:'enemyCatapult',n:1}] },
  { enemies: [{t:'armoredTroll',n:5},{t:'banditRaider',n:4},{t:'enemyCatapult',n:2}] },
  // Level 15 BOSS
  { enemies: [{t:'stoneGiant',n:1},{t:'armoredTroll',n:3},{t:'orcBrute',n:3}], boss:true },
  // 16-19
  { enemies: [{t:'armoredTroll',n:4},{t:'orcBrute',n:5},{t:'enemyCatapult',n:3}] },
  { enemies: [{t:'armoredTroll',n:5},{t:'banditRaider',n:5},{t:'enemyCatapult',n:2}] },
  { enemies: [{t:'stoneGiant',n:1},{t:'armoredTroll',n:4},{t:'orcBrute',n:4},{t:'enemyCatapult',n:2}] },
  { enemies: [{t:'stoneGiant',n:1},{t:'armoredTroll',n:5},{t:'enemyCatapult',n:3},{t:'banditRaider',n:3}] },
  // Level 20 BOSS
  { enemies: [{t:'dragon',n:1},{t:'stoneGiant',n:1},{t:'armoredTroll',n:3},{t:'orcBrute',n:4}], boss:true }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START SCREEN LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    mathMode = btn.dataset.mode;
    document.getElementById('start-btn').disabled = false;
    resumeAC();
    playTone(440,'sine',0.1,0.2);
  });
});

document.getElementById('start-btn').addEventListener('click', () => {
  if (!mathMode) return;
  document.getElementById('start-screen').style.display = 'none';
  initGame();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initGame() {
  level = 1; coins = 200; checkpoint = 1;
  battleHistory = [];
  survivingUnits = [];
  playerGrid = Array.from({length:PLAYER_ROWS}, ()=>Array(PLAYER_COLS).fill(null));
  // Give starter pack
  setGridUnit(2, 0, 'swordsman');
  setGridUnit(2, 1, 'swordsman');
  setGridUnit(2, 2, 'spearman');
  setGridUnit(1, 2, 'archer');
  setGridUnit(2, 3, 'swordsman');
  startPlacement();
}

function setGridUnit(row, col, type) {
  if (row>=0 && row<PLAYER_ROWS && col>=0 && col<PLAYER_COLS) {
    const def = PLAYER_UNITS[type];
    playerGrid[row][col] = { type, hp: def.hp, maxHp: def.hp };
  }
}

function countUnits() {
  let n=0;
  for(let r=0;r<PLAYER_ROWS;r++) for(let c=0;c<PLAYER_COLS;c++) if(playerGrid[r][c]) n++;
  return n;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLACEMENT PHASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startPlacement() {
  gameState = 'PLACEMENT';
  sellMode = false;
  selectedUnit = null;
  activePowerups = { rally:false, shield:false, medic:false };
  updateHUD();
  buildShop();

  document.getElementById('placement-ui').style.display = 'block';
  document.getElementById('battle-ui').style.display = 'none';
  document.getElementById('hud-phase').textContent = 'üè∞ DEPLOYMENT';

  document.getElementById('sell-btn').onclick = () => {
    sellMode = !sellMode;
    selectedUnit = null;
    document.getElementById('sell-btn').classList.toggle('sell-mode', sellMode);
    document.getElementById('sell-btn').textContent = sellMode ? '‚ùå Cancel Sell' : 'üí∞ Sell Mode';
  };
  document.getElementById('clear-btn').onclick = clearAll;
  document.getElementById('battle-btn').onclick = startBattle;

  renderLoop();
}

function buildShop() {
  const scroll = document.getElementById('shop-scroll');
  scroll.innerHTML = '';
  Object.entries(PLAYER_UNITS).forEach(([key, def]) => {
    const btn = document.createElement('div');
    btn.className = 'shop-unit' + (coins < def.cost ? ' cant-afford' : '');
    btn.innerHTML = `<span class="unit-icon">${def.icon}</span>
      <span class="unit-name">${def.name}</span>
      <span class="unit-cost">üí∞${def.cost}</span>
      <span class="sell-hint">Sell: ${Math.floor(def.cost/2)}</span>`;
    btn.dataset.type = key;
    if (coins >= def.cost) {
      btn.onclick = () => {
        sellMode = false;
        document.getElementById('sell-btn').classList.remove('sell-mode');
        document.getElementById('sell-btn').textContent = 'üí∞ Sell Mode';
        selectedUnit = key;
        document.querySelectorAll('.shop-unit').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        playTone(600,'sine',0.1,0.2);
      };
    }
    scroll.appendChild(btn);
  });
}

function clearAll() {
  // Refund half
  for(let r=0;r<PLAYER_ROWS;r++) for(let c=0;c<PLAYER_COLS;c++) {
    if(playerGrid[r][c]) {
      coins += Math.floor(PLAYER_UNITS[playerGrid[r][c].type].cost/2);
      playerGrid[r][c] = null;
    }
  }
  updateHUD();
  buildShop();
}

// Grid click / touch handling
canvas.addEventListener('click', handleGridClick);
canvas.addEventListener('touchend', e => {
  e.preventDefault();
  const t = e.changedTouches[0];
  handleGridClick({clientX:t.clientX, clientY:t.clientY});
}, {passive:false});

function handleGridClick(e) {
  if (gameState !== 'PLACEMENT') return;
  const cell = getGridCell(e.clientX, e.clientY);
  if (!cell) return;
  const {row, col, side} = cell;
  if (side !== 'player') return;

  if (sellMode) {
    const u = playerGrid[row][col];
    if (u) {
      coins += Math.floor(PLAYER_UNITS[u.type].cost/2);
      playerGrid[row][col] = null;
      coinDing();
      updateHUD(); buildShop();
    }
    return;
  }

  if (selectedUnit) {
    if (countUnits() >= 15 && !playerGrid[row][col]) {
      showFloatText(e.clientX, e.clientY, 'Grid Full!', '#f54040');
      return;
    }
    if (coins >= PLAYER_UNITS[selectedUnit].cost) {
      // Refund old unit half price if replacing
      if (playerGrid[row][col]) {
        coins += Math.floor(PLAYER_UNITS[playerGrid[row][col].type].cost/2);
      }
      coins -= PLAYER_UNITS[selectedUnit].cost;
      const def = PLAYER_UNITS[selectedUnit];
      playerGrid[row][col] = { type: selectedUnit, hp: def.hp, maxHp: def.hp };
      playTone(440,'sine',0.1,0.2);
      updateHUD(); buildShop();
    } else {
      showFloatText(e.clientX, e.clientY, 'Not enough coins!', '#f54040');
    }
  } else if (playerGrid[row][col]) {
    // Select to move - could implement drag but keep simple: just remove
    // Toggle empty
  }
}

function getGridCell(x, y) {
  const W = canvas.width, H = canvas.height;
  const topY = 60, bottomY = H - 130;
  const gridH = (bottomY - topY);
  const cellH = gridH / 6; // 3 enemy rows + 3 player rows
  const cellW = W / PLAYER_COLS;

  const col = Math.floor(x / cellW);
  if (col < 0 || col >= PLAYER_COLS) return null;

  const relY = y - topY;
  const rowIdx = Math.floor(relY / cellH);

  if (rowIdx >= 0 && rowIdx < 3) {
    return { side:'enemy', row: rowIdx, col };
  } else if (rowIdx >= 3 && rowIdx < 6) {
    return { side:'player', row: rowIdx-3, col };
  }
  return null;
}

function updateHUD() {
  document.getElementById('hud-level').textContent = level;
  document.getElementById('hud-coins').textContent = coins;
  document.getElementById('hud-units').textContent = countUnits();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAWING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let animFrame = null;
function renderLoop() {
  if (animFrame) cancelAnimationFrame(animFrame);
  function loop() {
    draw();
    animFrame = requestAnimationFrame(loop);
  }
  loop();
}

function draw() {
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // Background
  drawBackground(W, H);

  if (gameState === 'PLACEMENT' || gameState === 'BATTLE') {
    drawBattlefield(W, H);
  }

  // Particles
  drawParticles();

  // Floating texts
  drawFloatingTexts(W, H);
}

function drawBackground(W, H) {
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, '#0a0608');
  g.addColorStop(0.4, '#0d0a1a');
  g.addColorStop(1, '#0a0608');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // Stars
  ctx.fillStyle = '#ffffff22';
  for(let i=0;i<80;i++) {
    const sx = ((i*373)%W), sy = ((i*199)%(H*0.5));
    const ss = ((i*7)%3+1)*0.5;
    ctx.beginPath();
    ctx.arc(sx, sy, ss, 0, Math.PI*2);
    ctx.fill();
  }

  // Horizon glow
  const hg = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, W*0.6);
  hg.addColorStop(0,'#2a1a0a08');
  hg.addColorStop(1,'transparent');
  ctx.fillStyle = hg;
  ctx.fillRect(0,0,W,H);
}

function drawBattlefield(W, H) {
  const topY = 60, bottomY = H - (gameState==='PLACEMENT'?130:70);
  const gridH = bottomY - topY;
  const cellH = gridH / 6;
  const cellW = W / PLAYER_COLS;

  // Dividing line
  const midY = topY + cellH * 3;
  ctx.strokeStyle = '#4a2e1a88';
  ctx.lineWidth = 2;
  ctx.setLineDash([8,4]);
  ctx.beginPath();
  ctx.moveTo(0, midY); ctx.lineTo(W, midY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Grid lines
  ctx.strokeStyle = '#ffffff08';
  ctx.lineWidth = 1;
  for(let r=0;r<=6;r++) {
    const y = topY + r*cellH;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  for(let c=0;c<=PLAYER_COLS;c++) {
    const x = c*cellW;
    ctx.beginPath(); ctx.moveTo(x,topY); ctx.lineTo(x,bottomY); ctx.stroke();
  }

  // Zone labels
  ctx.font = 'bold 11px Cinzel, serif';
  ctx.textAlign = 'left';
  ctx.fillStyle = '#ff444422';
  ctx.fillText('‚öî ENEMY TERRITORY', 8, topY+15);
  ctx.fillStyle = '#4444ff22';
  ctx.fillText('üõ° YOUR ARMY', 8, midY+18);

  // Hover highlight (placement mode)
  if (gameState === 'PLACEMENT' && selectedUnit) {
    const mx = lastMouseX, my = lastMouseY;
    const cell = getGridCell(mx, my);
    if (cell && cell.side === 'player') {
      const hx = cell.col * cellW, hy = topY + (cell.row+3)*cellH;
      ctx.fillStyle = '#4a8aff22';
      ctx.fillRect(hx, hy, cellW, cellH);
      ctx.strokeStyle = '#4a8aff88';
      ctx.lineWidth = 2;
      ctx.strokeRect(hx, hy, cellW, cellH);
    }
  }

  // Draw placement units
  if (gameState === 'PLACEMENT') {
    drawPlacementGrid(topY, cellH, cellW);
    drawEnemyPreview(topY, cellH, cellW);
  }

  // Draw battle units
  if (gameState === 'BATTLE') {
    drawBattleUnits();
    drawProjectiles();
  }
}

function drawPlacementGrid(topY, cellH, cellW) {
  for(let r=0; r<PLAYER_ROWS; r++) {
    for(let c=0; c<PLAYER_COLS; c++) {
      const u = playerGrid[r][c];
      if (!u) continue;
      const def = PLAYER_UNITS[u.type];
      const cx = c*cellW + cellW/2;
      const cy = topY + (r+3)*cellH + cellH/2;
      drawUnitSprite(ctx, cx, cy, Math.min(cellW,cellH)*0.8, def, u, 'player');
    }
  }
}

function drawEnemyPreview(topY, cellH, cellW) {
  // Show enemy formation preview
  const lvlDef = LEVELS[level-1];
  let enemies = generateEnemyGrid(lvlDef);
  for(let r=0;r<3;r++) for(let c=0;c<PLAYER_COLS;c++) {
    if(enemies[r][c]) {
      const def = ENEMY_DEFS[enemies[r][c].type];
      const cx = c*cellW+cellW/2;
      const cy = topY+r*cellH+cellH/2;
      ctx.globalAlpha = 0.4;
      drawUnitSprite(ctx, cx, cy, Math.min(cellW,cellH)*0.8, def, enemies[r][c], 'enemy');
      ctx.globalAlpha = 1;
    }
  }
  // "ENEMY" label overlay
  ctx.globalAlpha = 1;
}

function generateEnemyGrid(lvlDef) {
  const grid = Array.from({length:3},()=>Array(PLAYER_COLS).fill(null));
  const units = [];
  lvlDef.enemies.forEach(e => {
    for(let i=0;i<e.n;i++) {
      const def = ENEMY_DEFS[e.t];
      units.push({type:e.t, hp:def.hp, maxHp:def.hp});
    }
  });
  // Fill grid: front row first (row 2), then 1, then 0
  const rowOrder = [2,1,0];
  let ui = 0;
  for(const row of rowOrder) {
    for(let c=0;c<PLAYER_COLS&&ui<units.length;c++) {
      grid[row][c] = units[ui++];
    }
  }
  return grid;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPRITE DRAWING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawUnitSprite(ctx, cx, cy, size, def, unit, side) {
  const s = size * 0.42;
  const isEnemy = side === 'enemy';
  const flip = isEnemy ? -1 : 1;

  ctx.save();
  ctx.translate(cx, cy);

  // Shadow
  ctx.fillStyle = '#00000044';
  ctx.beginPath();
  ctx.ellipse(0, s*0.85, s*0.5, s*0.15, 0, 0, Math.PI*2);
  ctx.fill();

  // Determine unit shape by type key
  const type = unit.type || unit.t;
  if (def.isBoss) drawBossSprite(ctx, s, def, flip);
  else if (type==='trebuchet' || type==='catapult' || type==='enemyCatapult') drawSiegeSprite(ctx, s, def, flip, type);
  else if (type==='archer' || type==='crossbow') drawArcherSprite(ctx, s, def, flip);
  else if (type==='royalGuard') drawRoyalGuardSprite(ctx, s, def, flip);
  else if (type==='knight') drawKnightSprite(ctx, s, def, flip);
  else if (type==='heavyInfantry') drawHeavyInfSprite(ctx, s, def, flip);
  else if (type==='swordsman') drawSwordsmanSprite(ctx, s, def, flip);
  else if (type==='spearman') drawSpearmanSprite(ctx, s, def, flip);
  else if (type==='orcBrute') drawOrcSprite(ctx, s, def, flip);
  else if (type==='armoredTroll') drawTrollSprite(ctx, s, def, flip);
  else if (type==='goblinScout') drawGoblinSprite(ctx, s, def, flip);
  else if (type==='skeletonWarr') drawSkeletonSprite(ctx, s, def, flip);
  else if (type==='banditRaider') drawBanditSprite(ctx, s, def, flip);
  else drawGenericSprite(ctx, s, def, flip);

  // HP bar
  if (unit.hp !== undefined && unit.hp < unit.maxHp) {
    const bw = s*1.8, bh = 4;
    const bx = -bw/2, by = -s*1.2;
    ctx.fillStyle = '#333';
    ctx.fillRect(bx, by, bw, bh);
    const pct = Math.max(0, unit.hp/unit.maxHp);
    const hpColor = pct > 0.5 ? '#40f580' : pct > 0.25 ? '#f5a020' : '#f54040';
    ctx.fillStyle = hpColor;
    ctx.fillRect(bx, by, bw*pct, bh);
  }

  ctx.restore();
}

function drawGenericSprite(ctx, s, def, flip) {
  // Body
  ctx.fillStyle = def.color;
  ctx.fillRect(-s*0.35, -s*0.7, s*0.7, s*1.0);
  // Head
  ctx.beginPath();
  ctx.arc(0, -s*0.85, s*0.25, 0, Math.PI*2);
  ctx.fillStyle = '#f5c090';
  ctx.fill();
  // Helmet
  ctx.fillStyle = def.accent;
  ctx.beginPath();
  ctx.arc(0, -s*0.9, s*0.26, Math.PI, 0);
  ctx.fill();
  // Weapon
  ctx.strokeStyle = '#c0c0c0';
  ctx.lineWidth = s*0.08;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.35, -s*0.6);
  ctx.lineTo(flip*s*0.7, -s*1.0);
  ctx.stroke();
}

function drawSwordsmanSprite(ctx, s, def, flip) {
  // Torso
  ctx.fillStyle = def.color;
  ctx.fillRect(-s*0.32, -s*0.65, s*0.64, s*0.9);
  // Legs
  ctx.fillStyle = def.accent;
  ctx.fillRect(-s*0.3, s*0.2, s*0.25, s*0.5);
  ctx.fillRect(s*0.05, s*0.2, s*0.25, s*0.5);
  // Head
  ctx.fillStyle = '#f5c090';
  ctx.beginPath(); ctx.arc(0,-s*0.8,s*0.22,0,Math.PI*2); ctx.fill();
  // Helmet
  ctx.fillStyle = def.accent;
  ctx.beginPath(); ctx.arc(0,-s*0.85,s*0.24,Math.PI,0); ctx.fill();
  ctx.fillRect(-s*0.24,-s*0.88,s*0.48,s*0.1);
  // Shield
  ctx.fillStyle = def.accent;
  ctx.fillRect(-flip*s*0.55, -s*0.6, s*0.22, s*0.45);
  ctx.strokeStyle='#fff4'; ctx.lineWidth=1;
  ctx.strokeRect(-flip*s*0.55,-s*0.6,s*0.22,s*0.45);
  // Sword
  ctx.strokeStyle='#d0d0d0'; ctx.lineWidth=s*0.1;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.35,-s*0.3);
  ctx.lineTo(flip*s*0.6,-s*0.85);
  ctx.stroke();
  // Crossguard
  ctx.strokeStyle='#a08020'; ctx.lineWidth=s*0.12;
  ctx.beginPath();
  ctx.moveTo(flip*(s*0.35+s*0.15),-s*0.45);
  ctx.lineTo(flip*(s*0.35-s*0.15),-s*0.45);
  ctx.stroke();
}

function drawSpearmanSprite(ctx, s, def, flip) {
  drawGenericSprite(ctx, s, def, flip);
  // Spear shaft
  ctx.strokeStyle = '#8b5a2b'; ctx.lineWidth = s*0.06;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.3, s*0.5);
  ctx.lineTo(flip*s*0.5, -s*1.3);
  ctx.stroke();
  // Spear tip
  ctx.fillStyle = '#c0c0c0';
  ctx.beginPath();
  ctx.moveTo(flip*s*0.5, -s*1.3);
  ctx.lineTo(flip*(s*0.5-s*0.1), -s*1.0);
  ctx.lineTo(flip*(s*0.5+s*0.1), -s*1.0);
  ctx.closePath(); ctx.fill();
}

function drawArcherSprite(ctx, s, def, flip) {
  // Light armor - leather
  ctx.fillStyle = '#8b6914'; // leather brown
  ctx.fillRect(-s*0.28, -s*0.6, s*0.56, s*0.85);
  ctx.fillStyle = def.accent;
  // Hood
  ctx.fillStyle = def.color;
  ctx.beginPath(); ctx.arc(0,-s*0.8,s*0.22,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); // Hood top
  ctx.moveTo(-s*0.22,-s*0.8); ctx.lineTo(0,-s*1.1); ctx.lineTo(s*0.22,-s*0.8);
  ctx.closePath(); ctx.fill();
  // Bow
  ctx.strokeStyle='#8b5a2b'; ctx.lineWidth=s*0.07;
  ctx.beginPath();
  ctx.arc(-flip*s*0.5, -s*0.3, s*0.5, -Math.PI*0.5, Math.PI*0.5, flip<0);
  ctx.stroke();
  // Bowstring
  ctx.strokeStyle='#c8c8a8'; ctx.lineWidth=s*0.03;
  ctx.beginPath();
  ctx.moveTo(-flip*s*0.5,-s*0.8); ctx.lineTo(-flip*s*0.5,s*0.2); ctx.stroke();
  // Arrow
  ctx.strokeStyle='#8b5a2b'; ctx.lineWidth=s*0.04;
  ctx.beginPath();
  ctx.moveTo(-flip*s*0.4,-s*0.3); ctx.lineTo(flip*s*0.4,-s*0.3); ctx.stroke();
}

function drawKnightSprite(ctx, s, def, flip) {
  // Plate armor
  ctx.fillStyle = def.color;
  ctx.beginPath();
  ctx.roundRect(-s*0.38, -s*0.7, s*0.76, s*1.0, s*0.1);
  ctx.fill();
  // Pauldrons
  ctx.fillStyle = def.accent;
  ctx.beginPath(); ctx.ellipse(-s*0.45,-s*0.55,s*0.2,s*0.14,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.45,-s*0.55,s*0.2,s*0.14,0,0,Math.PI*2); ctx.fill();
  // Helmet
  ctx.fillStyle = def.color;
  ctx.beginPath(); ctx.arc(0,-s*0.85,s*0.28,0,Math.PI*2); ctx.fill();
  // Visor
  ctx.fillStyle = '#00000044';
  ctx.fillRect(-s*0.18,-s*0.88,s*0.36,s*0.12);
  // Shield
  ctx.fillStyle = def.accent;
  ctx.beginPath();
  ctx.moveTo(-flip*s*0.55,-s*0.7);
  ctx.lineTo(-flip*s*0.55,-s*0.1);
  ctx.lineTo(-flip*s*0.35,s*0.1);
  ctx.lineTo(-flip*s*0.15,-s*0.1);
  ctx.lineTo(-flip*s*0.15,-s*0.7);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle='#fff4';ctx.lineWidth=1;ctx.stroke();
  // Cross on shield
  ctx.strokeStyle='#fff8';ctx.lineWidth=s*0.05;
  ctx.beginPath();
  ctx.moveTo(-flip*s*0.35,-s*0.6);ctx.lineTo(-flip*s*0.35,-s*0.2);
  ctx.moveTo(-flip*s*0.5,-s*0.4);ctx.lineTo(-flip*s*0.2,-s*0.4);
  ctx.stroke();
  // Sword
  ctx.strokeStyle='#e0e0e0';ctx.lineWidth=s*0.09;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.38,-s*0.4);ctx.lineTo(flip*s*0.55,-s*1.0);
  ctx.stroke();
}

function drawHeavyInfSprite(ctx, s, def, flip) {
  // Very bulky
  ctx.fillStyle = def.color;
  ctx.beginPath();
  ctx.roundRect(-s*0.45,-s*0.75,s*0.9,s*1.1,s*0.08);
  ctx.fill();
  ctx.fillStyle = def.accent;
  // Chest plate stripes
  for(let i=0;i<3;i++) {
    ctx.fillRect(-s*0.38,-s*0.6+i*s*0.22,s*0.76,s*0.08);
  }
  // Big helmet
  ctx.fillStyle = def.color;
  ctx.beginPath(); ctx.arc(0,-s*0.88,s*0.32,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=def.accent;
  ctx.fillRect(-s*0.32,-s*0.92,s*0.64,s*0.1);
  // Great axe
  ctx.strokeStyle='#a08020';ctx.lineWidth=s*0.08;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.42,s*0.3);ctx.lineTo(flip*s*0.55,-s*1.1);
  ctx.stroke();
  ctx.fillStyle='#c0c0c0';
  ctx.beginPath();
  ctx.moveTo(flip*s*0.55,-s*1.1);
  ctx.lineTo(flip*(s*0.55+s*0.25),-s*0.8);
  ctx.lineTo(flip*(s*0.55+s*0.1),-s*0.65);
  ctx.lineTo(flip*s*0.55,-s*0.8);
  ctx.closePath();ctx.fill();
}

function drawRoyalGuardSprite(ctx, s, def, flip) {
  // Gold armor
  ctx.fillStyle = def.color;
  ctx.beginPath();
  ctx.roundRect(-s*0.38,-s*0.72,s*0.76,s*1.02,s*0.08);
  ctx.fill();
  // Gold trim
  ctx.strokeStyle='#fff6';ctx.lineWidth=s*0.04;
  ctx.strokeRect(-s*0.38,-s*0.72,s*0.76,s*1.02);
  // Plumed helmet
  ctx.fillStyle = def.color;
  ctx.beginPath(); ctx.arc(0,-s*0.85,s*0.28,0,Math.PI*2); ctx.fill();
  // Plume (red)
  ctx.fillStyle='#f54040';
  ctx.beginPath();
  ctx.moveTo(-s*0.1,-s*1.05);
  ctx.quadraticCurveTo(-s*0.3,-s*1.4, 0,-s*1.5);
  ctx.quadraticCurveTo(s*0.1,-s*1.4, s*0.05,-s*1.05);
  ctx.closePath();ctx.fill();
  // Halberd
  ctx.strokeStyle='#8b5a2b';ctx.lineWidth=s*0.07;
  ctx.beginPath();
  ctx.moveTo(flip*s*0.4,s*0.3);ctx.lineTo(flip*s*0.5,-s*1.3);
  ctx.stroke();
  ctx.fillStyle='#f5d76e';
  ctx.beginPath();
  ctx.moveTo(flip*s*0.5,-s*1.3);
  ctx.lineTo(flip*(s*0.5+s*0.2),-s*1.0);
  ctx.lineTo(flip*s*0.5,-s*0.9);
  ctx.lineTo(flip*(s*0.5-s*0.08),-s*1.0);
  ctx.closePath();ctx.fill();
}

function drawSiegeSprite(ctx, s, def, flip, type) {
  // Wheels
  ctx.fillStyle = '#5c3a00';
  ctx.beginPath();ctx.arc(-s*0.5,s*0.5,s*0.3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.3,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#8b5a2b';ctx.lineWidth=s*0.05;
  ctx.beginPath();ctx.arc(-s*0.5,s*0.5,s*0.3,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.3,0,Math.PI*2);ctx.stroke();
  // Frame
  ctx.fillStyle=def.color;
  ctx.fillRect(-s*0.6,s*0.1,s*1.2,s*0.25);
  if(type==='trebuchet') {
    // Long arm
    ctx.strokeStyle=def.color;ctx.lineWidth=s*0.1;
    ctx.beginPath();
    ctx.moveTo(-flip*s*0.4,s*0.1);
    ctx.lineTo(flip*s*0.5,-s*1.0);
    ctx.stroke();
    // Counterweight
    ctx.fillStyle=def.accent;
    ctx.beginPath();ctx.arc(-flip*s*0.4,s*0.2,s*0.2,0,Math.PI*2);ctx.fill();
    // Sling
    ctx.strokeStyle='#8b5a2b';ctx.lineWidth=s*0.04;
    ctx.beginPath();ctx.moveTo(flip*s*0.5,-s*1.0);ctx.lineTo(flip*s*0.3,-s*0.5);ctx.stroke();
  } else {
    // Catapult arm (shorter)
    ctx.strokeStyle=def.color;ctx.lineWidth=s*0.1;
    ctx.beginPath();
    ctx.moveTo(-flip*s*0.2,s*0.1);
    ctx.lineTo(flip*s*0.4,-s*0.7);
    ctx.stroke();
    ctx.fillStyle=def.accent;
    ctx.beginPath();ctx.arc(-flip*s*0.2,s*0.15,s*0.18,0,Math.PI*2);ctx.fill();
  }
}

function drawBossSprite(ctx, s, def, flip) {
  const type = def.name;
  if(type.includes('DRAGON')) {
    // Dragon - imposing
    ctx.fillStyle=def.color;
    // Body
    ctx.beginPath();ctx.ellipse(0,0,s*0.8,s*0.5,0,0,Math.PI*2);ctx.fill();
    // Head
    ctx.beginPath();ctx.ellipse(flip*s*0.7,-s*0.2,s*0.4,s*0.3,flip*0.3,0,Math.PI*2);ctx.fill();
    // Snout
    ctx.beginPath();
    ctx.moveTo(flip*s*1.0,-s*0.1);
    ctx.lineTo(flip*s*1.3,-s*0.05);
    ctx.lineTo(flip*s*1.0,s*0.1);
    ctx.closePath();ctx.fill();
    // Eye
    ctx.fillStyle='#ffff00';
    ctx.beginPath();ctx.arc(flip*s*0.8,-s*0.25,s*0.08,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.arc(flip*s*0.82,-s*0.25,s*0.04,0,Math.PI*2);ctx.fill();
    // Wings
    ctx.fillStyle=def.accent;
    ctx.beginPath();
    ctx.moveTo(0,-s*0.2);
    ctx.lineTo(-flip*s*0.3,-s*1.2);
    ctx.lineTo(flip*s*0.1,-s*0.8);
    ctx.lineTo(flip*s*0.2,-s*0.3);
    ctx.closePath();ctx.fill();
    // Flame
    ctx.fillStyle='#ff6020aa';
    ctx.beginPath();
    ctx.moveTo(flip*s*1.3,-s*0.05);
    ctx.lineTo(flip*s*1.9,-s*0.3);
    ctx.lineTo(flip*s*2.0,s*0.05);
    ctx.lineTo(flip*s*1.9,s*0.3);
    ctx.lineTo(flip*s*1.3,s*0.1);
    ctx.closePath();ctx.fill();
  } else if(type.includes('GIANT')) {
    // Stone Giant
    ctx.fillStyle=def.color;
    ctx.beginPath();ctx.roundRect(-s*0.55,-s*0.9,s*1.1,s*1.4,s*0.1);ctx.fill();
    ctx.fillStyle=def.accent;
    for(let i=0;i<4;i++) ctx.fillRect(-s*0.45,-s*0.7+i*s*0.3,s*0.9,s*0.08);
    // Giant head
    ctx.fillStyle='#a0a0a0';
    ctx.beginPath();ctx.arc(0,-s*1.05,s*0.38,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffff00';
    ctx.beginPath();ctx.arc(-s*0.12,-s*1.1,s*0.08,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(s*0.12,-s*1.1,s*0.08,0,Math.PI*2);ctx.fill();
    // Boulder
    ctx.fillStyle='#808080';
    ctx.beginPath();ctx.arc(flip*s*0.65,-s*0.5,s*0.25,0,Math.PI*2);ctx.fill();
  } else if(type.includes('WIZARD')) {
    // Shadow Wizard
    ctx.fillStyle=def.color;
    // Robe
    ctx.beginPath();
    ctx.moveTo(-s*0.2,-s*0.7);ctx.lineTo(-s*0.5,s*0.7);ctx.lineTo(s*0.5,s*0.7);ctx.lineTo(s*0.2,-s*0.7);
    ctx.closePath();ctx.fill();
    // Head
    ctx.fillStyle='#201030';
    ctx.beginPath();ctx.arc(0,-s*0.88,s*0.25,0,Math.PI*2);ctx.fill();
    // Hat
    ctx.fillStyle=def.color;
    ctx.beginPath();
    ctx.moveTo(-s*0.35,-s*0.78);ctx.lineTo(0,-s*1.5);ctx.lineTo(s*0.35,-s*0.78);
    ctx.closePath();ctx.fill();
    // Glowing eyes
    ctx.fillStyle='#ff00ff';
    ctx.beginPath();ctx.arc(-s*0.1,-s*0.9,s*0.06,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(s*0.1,-s*0.9,s*0.06,0,Math.PI*2);ctx.fill();
    // Staff
    ctx.strokeStyle=def.color;ctx.lineWidth=s*0.07;
    ctx.beginPath();ctx.moveTo(flip*s*0.3,s*0.5);ctx.lineTo(flip*s*0.4,-s*1.2);ctx.stroke();
    ctx.fillStyle='#ff00ff';
    ctx.beginPath();ctx.arc(flip*s*0.4,-s*1.2,s*0.14,0,Math.PI*2);ctx.fill();
    // Glow
    const grd=ctx.createRadialGradient(flip*s*0.4,-s*1.2,0,flip*s*0.4,-s*1.2,s*0.35);
    grd.addColorStop(0,'#ff00ff44');grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd;
    ctx.beginPath();ctx.arc(flip*s*0.4,-s*1.2,s*0.35,0,Math.PI*2);ctx.fill();
  } else {
    // Ogre Chief
    ctx.fillStyle=def.color;
    ctx.beginPath();ctx.roundRect(-s*0.5,-s*0.8,s*1.0,s*1.2,s*0.1);ctx.fill();
    ctx.fillStyle=def.accent;
    ctx.fillRect(-s*0.45,-s*0.5,s*0.9,s*0.08);
    // Head
    ctx.fillStyle='#d06030';
    ctx.beginPath();ctx.arc(0,-s*0.95,s*0.35,0,Math.PI*2);ctx.fill();
    // Horns
    ctx.fillStyle='#804020';
    ctx.beginPath();ctx.moveTo(-s*0.2,-s*1.15);ctx.lineTo(-s*0.35,-s*1.5);ctx.lineTo(-s*0.1,-s*1.2);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(s*0.2,-s*1.15);ctx.lineTo(s*0.35,-s*1.5);ctx.lineTo(s*0.1,-s*1.2);ctx.closePath();ctx.fill();
    // Eyes
    ctx.fillStyle='#ffcc00';
    ctx.beginPath();ctx.arc(-s*0.1,-s*1.0,s*0.08,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(s*0.1,-s*1.0,s*0.08,0,Math.PI*2);ctx.fill();
    // Club
    ctx.strokeStyle='#5c3000';ctx.lineWidth=s*0.12;
    ctx.beginPath();ctx.moveTo(flip*s*0.5,s*0.3);ctx.lineTo(flip*s*0.6,-s*0.9);ctx.stroke();
    ctx.fillStyle='#5c3000';
    ctx.beginPath();ctx.arc(flip*s*0.6,-s*0.9,s*0.2,0,Math.PI*2);ctx.fill();
  }
}

function drawGoblinSprite(ctx, s, def, flip) {
  ctx.fillStyle='#3a7a20';
  ctx.beginPath();ctx.arc(0,-s*0.82,s*0.22,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=def.color;
  ctx.fillRect(-s*0.28,-s*0.6,s*0.56,s*0.8);
  ctx.fillStyle='#3a7a20';
  ctx.fillRect(-s*0.28,s*0.15,s*0.2,s*0.45);
  ctx.fillRect(s*0.08,s*0.15,s*0.2,s*0.45);
  // Ears
  ctx.beginPath();ctx.arc(-s*0.22,-s*0.88,s*0.1,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.22,-s*0.88,s*0.1,0,Math.PI*2);ctx.fill();
  // Dagger
  ctx.strokeStyle='#c0c0c0';ctx.lineWidth=s*0.07;
  ctx.beginPath();ctx.moveTo(flip*s*0.28,-s*0.3);ctx.lineTo(flip*s*0.5,-s*0.7);ctx.stroke();
}

function drawSkeletonSprite(ctx, s, def, flip) {
  // Ribcage
  ctx.strokeStyle=def.color;ctx.lineWidth=s*0.06;
  for(let i=0;i<4;i++) {
    ctx.beginPath();
    ctx.moveTo(-s*0.3,-s*0.5+i*s*0.18);ctx.lineTo(s*0.3,-s*0.5+i*s*0.18);
    ctx.stroke();
  }
  // Spine
  ctx.beginPath();ctx.moveTo(0,-s*0.7);ctx.lineTo(0,s*0.3);ctx.stroke();
  // Skull
  ctx.fillStyle=def.color;
  ctx.beginPath();ctx.arc(0,-s*0.88,s*0.22,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';
  ctx.beginPath();ctx.arc(-s*0.08,-s*0.9,s*0.06,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.08,-s*0.9,s*0.06,0,Math.PI*2);ctx.fill();
  // Scythe
  ctx.strokeStyle='#808080';ctx.lineWidth=s*0.06;
  ctx.beginPath();ctx.moveTo(flip*s*0.2,s*0.3);ctx.lineTo(flip*s*0.4,-s*1.1);ctx.stroke();
  ctx.beginPath();
  ctx.arc(flip*s*0.15,-s*0.95,s*0.3,-Math.PI*0.5,0);ctx.stroke();
}

function drawBanditSprite(ctx, s, def, flip) {
  ctx.fillStyle='#704020';
  ctx.fillRect(-s*0.3,-s*0.65,s*0.6,s*0.88);
  ctx.fillStyle='#f5c090';
  ctx.beginPath();ctx.arc(0,-s*0.82,s*0.22,0,Math.PI*2);ctx.fill();
  // Bandana
  ctx.fillStyle='#c03020';
  ctx.fillRect(-s*0.23,-s*0.9,s*0.46,s*0.12);
  // Knife
  ctx.strokeStyle='#d0d0d0';ctx.lineWidth=s*0.07;
  ctx.beginPath();ctx.moveTo(flip*s*0.28,-s*0.2);ctx.lineTo(flip*s*0.6,-s*0.6);ctx.stroke();
}

function drawOrcSprite(ctx, s, def, flip) {
  ctx.fillStyle='#308020';
  ctx.beginPath();ctx.roundRect(-s*0.42,-s*0.72,s*0.84,s*1.02,s*0.08);ctx.fill();
  ctx.fillStyle='#508030';
  ctx.fillRect(-s*0.35,-s*0.5,s*0.7,s*0.08);
  // Head
  ctx.fillStyle='#308020';
  ctx.beginPath();ctx.arc(0,-s*0.88,s*0.28,0,Math.PI*2);ctx.fill();
  // Tusks
  ctx.fillStyle='#f5f5c8';
  ctx.beginPath();ctx.moveTo(-s*0.1,-s*0.7);ctx.lineTo(-s*0.18,-s*0.52);ctx.lineTo(-s*0.04,-s*0.65);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(s*0.1,-s*0.7);ctx.lineTo(s*0.18,-s*0.52);ctx.lineTo(s*0.04,-s*0.65);ctx.closePath();ctx.fill();
  // Eyes
  ctx.fillStyle='#f50';
  ctx.beginPath();ctx.arc(-s*0.1,-s*0.96,s*0.07,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.1,-s*0.96,s*0.07,0,Math.PI*2);ctx.fill();
  // Battle axe
  ctx.strokeStyle='#5c3000';ctx.lineWidth=s*0.09;
  ctx.beginPath();ctx.moveTo(flip*s*0.42,s*0.28);ctx.lineTo(flip*s*0.5,-s*0.9);ctx.stroke();
  ctx.fillStyle='#c0c0c0';
  ctx.beginPath();
  ctx.moveTo(flip*s*0.5,-s*0.9);
  ctx.lineTo(flip*(s*0.5+s*0.22),-s*0.65);
  ctx.lineTo(flip*(s*0.5+s*0.1),-s*0.52);
  ctx.lineTo(flip*s*0.5,-s*0.68);
  ctx.closePath();ctx.fill();
}

function drawTrollSprite(ctx, s, def, flip) {
  ctx.fillStyle=def.color;
  ctx.beginPath();ctx.roundRect(-s*0.52,-s*0.85,s*1.04,s*1.25,s*0.1);ctx.fill();
  // Armor plates
  ctx.fillStyle=def.accent;
  ctx.fillRect(-s*0.45,-s*0.7,s*0.9,s*0.1);
  ctx.fillRect(-s*0.45,-s*0.4,s*0.9,s*0.1);
  ctx.fillRect(-s*0.45,-s*0.1,s*0.9,s*0.1);
  // Head
  ctx.fillStyle='#607060';
  ctx.beginPath();ctx.arc(0,-s*1.02,s*0.33,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=def.accent;
  ctx.beginPath();ctx.arc(0,-s*1.08,s*0.34,Math.PI,0);ctx.fill();
  // Eyes (angry)
  ctx.fillStyle='#ff2020';
  ctx.beginPath();ctx.arc(-s*0.1,-s*1.05,s*0.07,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(s*0.1,-s*1.05,s*0.07,0,Math.PI*2);ctx.fill();
  // Mace
  ctx.strokeStyle='#5c3000';ctx.lineWidth=s*0.1;
  ctx.beginPath();ctx.moveTo(flip*s*0.5,s*0.3);ctx.lineTo(flip*s*0.6,-s*0.9);ctx.stroke();
  ctx.fillStyle='#a0a0a0';
  ctx.beginPath();ctx.arc(flip*s*0.6,-s*0.9,s*0.22,0,Math.PI*2);ctx.fill();
  // Mace spikes
  for(let a=0;a<6;a++) {
    const angle=a*Math.PI/3;
    ctx.fillStyle='#c0c0c0';
    ctx.beginPath();
    ctx.moveTo(flip*s*0.6+Math.cos(angle)*s*0.22,-s*0.9+Math.sin(angle)*s*0.22);
    ctx.lineTo(flip*s*0.6+Math.cos(angle)*s*0.32,-s*0.9+Math.sin(angle)*s*0.32);
    ctx.lineTo(flip*s*0.6+Math.cos(angle+0.3)*s*0.28,-s*0.9+Math.sin(angle+0.3)*s*0.28);
    ctx.closePath();ctx.fill();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BATTLE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastMouseX = 0, lastMouseY = 0;
canvas.addEventListener('mousemove', e => { lastMouseX=e.clientX; lastMouseY=e.clientY; });

let battleStartTime = 0;
let battleOver = false;
let battleWon = false;
let battleTick = 0;
let lastBattleTime = 0;

function startBattle() {
  if (countUnits() === 0) {
    showFloatText(canvas.width/2, canvas.height/2, 'Place some units first!', '#f54040');
    return;
  }

  document.getElementById('placement-ui').style.display = 'none';
  document.getElementById('battle-ui').style.display = 'flex';
  document.getElementById('hud-phase').textContent = '‚öîÔ∏è BATTLE!';
  gameState = 'BATTLE';

  // Convert grids to battle units
  battleUnits = [];
  const W = canvas.width, H = canvas.height;
  const topY = 60, bottomY = H - 70;
  const gridH = (bottomY-topY)/6;
  const cellW = W/PLAYER_COLS;

  // Player units
  for(let r=0;r<PLAYER_ROWS;r++) {
    for(let c=0;c<PLAYER_COLS;c++) {
      const u = playerGrid[r][c];
      if(!u) continue;
      const def = PLAYER_UNITS[u.type];
      const id = battleUnits.length;
      let atk = def.atk, armor = def.def;
      if(activePowerups.rally) atk = Math.round(atk*1.35);
      if(activePowerups.shield) armor = Math.round(armor*1.4);
      battleUnits.push({
        id, type:u.type, name:def.name,
        x: c*cellW+cellW/2,
        y: topY+(r+3)*gridH+gridH/2,
        targetX: c*cellW+cellW/2,
        targetY: topY+(r+3)*gridH+gridH/2,
        hp: activePowerups.medic ? Math.min(u.hp+Math.round(def.hp*0.25), def.hp) : u.hp,
        maxHp: def.hp,
        atk, def:armor, range:def.range, speed:def.speed,
        isRanged:def.isRanged||false, isSiege:def.isSiege||false,
        side:'player', gridRow:r, gridCol:c,
        attackCooldown:0, attackRate: def.isSiege ? 180 : (def.isRanged ? 80 : 60),
        dead:false, state:'idle', target:null,
        color:def.color, accent:def.accent,
        flashTimer:0, deathTimer:0,
        baseX: c*cellW+cellW/2, baseY: topY+(r+3)*gridH+gridH/2
      });
    }
  }

  // Enemy units
  const lvlDef = LEVELS[level-1];
  const enemyGrid = generateEnemyGrid(lvlDef);
  for(let r=0;r<3;r++) {
    for(let c=0;c<PLAYER_COLS;c++) {
      const u = enemyGrid[r][c];
      if(!u) continue;
      const def = ENEMY_DEFS[u.type];
      battleUnits.push({
        id:battleUnits.length, type:u.type, name:def.name,
        x: c*cellW+cellW/2,
        y: topY+r*gridH+gridH/2,
        hp: u.hp, maxHp: def.hp,
        atk:def.atk, def:def.def, range:def.range, speed:def.speed,
        isRanged:def.isRanged||false, isSiege:def.isSiege||false,
        isBoss:def.isBoss||false,
        side:'enemy',
        attackCooldown:Math.floor(Math.random()*60),
        attackRate: def.isSiege ? 200 : (def.isRanged ? 90 : 65),
        dead:false, state:'idle', target:null,
        color:def.color, accent:def.accent,
        flashTimer:0, deathTimer:0,
        baseX: c*cellW+cellW/2, baseY: topY+r*gridH+gridH/2
      });
    }
  }

  // Record battle start
  const pStart = battleUnits.filter(u=>u.side==='player').length;
  const eStart = battleUnits.filter(u=>u.side==='enemy').length;

  battleOver = false;
  battleWon = false;
  battleTick = 0;
  lastBattleTime = performance.now();
  projectiles = [];
  particles = [];

  // Reset powerups display
  updatePowerupDisplay();

  // Battle loop
  function battleStep(now) {
    if (gameState !== 'BATTLE') return;
    const dt = now - lastBattleTime;
    lastBattleTime = now;
    battleTick += dt;

    updateBattle(dt);

    const playersAlive = battleUnits.filter(u=>u.side==='player'&&!u.dead).length;
    const enemiesAlive = battleUnits.filter(u=>u.side==='enemy'&&!u.dead).length;

    if (!battleOver) {
      if (enemiesAlive === 0) {
        battleOver = true;
        battleWon = true;
        victoryFanfare();
        setTimeout(()=>endBattle(pStart, eStart, true), 1500);
        return;
      }
      if (playersAlive === 0) {
        battleOver = true;
        battleWon = false;
        defeatSound();
        setTimeout(()=>endBattle(pStart, eStart, false), 1500);
        return;
      }
    }

    requestAnimationFrame(battleStep);
  }
  requestAnimationFrame(battleStep);
}

function updateBattle(dt) {
  const alive = battleUnits.filter(u=>!u.dead);

  for(const unit of alive) {
    if(unit.flashTimer>0) unit.flashTimer-=dt;
    if(unit.attackCooldown>0) unit.attackCooldown-=dt;

    // Find nearest enemy
    const enemies = alive.filter(u=>u.side!==unit.side);
    if(enemies.length===0) continue;

    let nearest = null, nearDist = Infinity;
    for(const e of enemies) {
      const d = Math.hypot(e.x-unit.x, e.y-unit.y);
      if(d<nearDist) { nearDist=d; nearest=e; }
    }
    unit.target = nearest;

    if(unit.isRanged || unit.isSiege) {
      // Ranged: stay in place or move to optimal range
      const optRange = unit.range * 0.8;
      if(nearDist > unit.range) {
        // Move toward target but stop at range
        const angle = Math.atan2(nearest.y-unit.y, nearest.x-unit.x);
        unit.x += Math.cos(angle) * unit.speed * dt / 1000 * 60;
        unit.y += Math.sin(angle) * unit.speed * dt / 1000 * 60;
      }
      if(nearDist <= unit.range && unit.attackCooldown <= 0) {
        fireProjectile(unit, nearest);
        unit.attackCooldown = unit.attackRate * (15 + Math.random()*15);
      }
    } else {
      // Melee: move toward target
      if(nearDist > unit.range * 0.9) {
        const angle = Math.atan2(nearest.y-unit.y, nearest.x-unit.x);
        unit.x += Math.cos(angle) * unit.speed * dt / 1000 * 60;
        unit.y += Math.sin(angle) * unit.speed * dt / 1000 * 60;
      } else if(unit.attackCooldown <= 0) {
        // Melee attack
        const dmg = Math.max(1, unit.atk - nearest.def * 0.6 + (Math.random()-0.5)*unit.atk*0.3);
        dealDamage(nearest, dmg, unit);
        unit.attackCooldown = unit.attackRate * (10 + Math.random()*10);
        swordClash();
        spawnMeleeParticles(nearest.x, nearest.y);
      }
    }
  }

  // Update projectiles
  for(const p of projectiles) {
    if(p.dead) continue;
    const dx = p.tx-p.x, dy = p.ty-p.y;
    const d = Math.hypot(dx,dy);
    if(d < 10) {
      // Hit
      if(!p.target.dead) {
        dealDamage(p.target, p.dmg, null);
        if(p.isSiege) { explosion(); spawnExplosion(p.x,p.y); }
        else { spawnImpactParticles(p.x,p.y,p.color); }
      }
      p.dead = true;
    } else {
      p.x += (dx/d)*p.speed*dt/1000*60;
      p.y += (dy/d)*p.speed*dt/1000*60;
      if(p.isSiege) p.y -= Math.sin(p.arc)*20*dt/1000*60;
      p.arc = Math.max(0, p.arc - 0.05);
    }
  }
  projectiles = projectiles.filter(p=>!p.dead);

  // Update particles
  for(const p of particles) {
    p.x+=p.vx*dt/16; p.y+=p.vy*dt/16;
    p.vy+=0.3; p.life-=dt/16;
    p.alpha = Math.max(0,p.life/p.maxLife);
  }
  particles = particles.filter(p=>p.life>0);
}

function fireProjectile(unit, target) {
  const color = unit.side==='player' ? '#f5d76e' : '#ff4444';
  const isSiege = unit.isSiege;
  const dmg = Math.max(1, unit.atk - target.def*0.4 + (Math.random()-0.5)*unit.atk*0.4);

  if(!isSiege) arrowWhoosh();

  projectiles.push({
    x:unit.x, y:unit.y,
    tx:target.x+((Math.random()-0.5)*20),
    ty:target.y+((Math.random()-0.5)*20),
    target, dmg,
    speed: isSiege?3.5:8,
    color, isSiege,
    arc: isSiege ? Math.PI*0.5 : 0,
    dead:false,
    size: isSiege?8:3
  });
}

function dealDamage(unit, dmg, attacker) {
  const actual = Math.round(dmg);
  unit.hp = Math.max(0, unit.hp - actual);
  unit.flashTimer = 150;
  showBattleFloat(unit.x, unit.y-20, `-${actual}`, unit.side==='player'?'#f54040':'#ffaa00');
  if(unit.hp<=0) killUnit(unit);
}

function killUnit(unit) {
  unit.dead = true;
  spawnDeathParticles(unit.x, unit.y, unit.color);
  explosion();
}

function spawnMeleeParticles(x, y) {
  for(let i=0;i<8;i++) {
    const angle = Math.random()*Math.PI*2;
    const speed = 2+Math.random()*3;
    particles.push({
      x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-2,
      color:'#f5d76e',size:2+Math.random()*2,
      life:20,maxLife:20,alpha:1
    });
  }
}

function spawnImpactParticles(x,y,color) {
  for(let i=0;i<6;i++) {
    const angle=Math.random()*Math.PI*2;
    particles.push({x,y,vx:Math.cos(angle)*(2+Math.random()*3),vy:Math.sin(angle)*(2+Math.random()*3)-2,color,size:3,life:15,maxLife:15,alpha:1});
  }
}

function spawnExplosion(x,y) {
  for(let i=0;i<20;i++) {
    const angle=Math.random()*Math.PI*2;
    const sp=3+Math.random()*6;
    const col=['#f5a020','#f54020','#f5f080','#ff2020'][Math.floor(Math.random()*4)];
    particles.push({x,y,vx:Math.cos(angle)*sp,vy:Math.sin(angle)*sp-3,color:col,size:3+Math.random()*5,life:35,maxLife:35,alpha:1});
  }
}

function spawnDeathParticles(x,y,color) {
  for(let i=0;i<15;i++) {
    const angle=Math.random()*Math.PI*2;
    const sp=2+Math.random()*5;
    particles.push({x,y,vx:Math.cos(angle)*sp,vy:Math.sin(angle)*sp-4,color,size:2+Math.random()*4,life:40,maxLife:40,alpha:1});
  }
}

function drawBattleUnits() {
  const W=canvas.width, H=canvas.height;
  const topY=60, bottomY=H-70;
  const gridH=(bottomY-topY)/6;
  const cellW=W/PLAYER_COLS;
  const sz=Math.min(cellW,gridH)*0.85;

  for(const unit of battleUnits) {
    if(unit.dead) continue;
    const isFlash = unit.flashTimer>0;
    const def = unit.side==='player' ? PLAYER_UNITS[unit.type] : ENEMY_DEFS[unit.type];

    ctx.save();
    if(isFlash) { ctx.globalAlpha=0.5; }
    drawUnitSprite(ctx, unit.x, unit.y, sz, def||unit, unit, unit.side);
    ctx.restore();

    // Name for bosses
    if(unit.isBoss) {
      ctx.fillStyle='#f5d76e';
      ctx.font='bold 11px Cinzel,serif';
      ctx.textAlign='center';
      ctx.fillText(unit.name, unit.x, unit.y-sz*0.7);
    }
  }
}

function drawProjectiles() {
  for(const p of projectiles) {
    ctx.save();
    ctx.globalAlpha=0.9;
    if(p.isSiege) {
      ctx.fillStyle='#808060';
      ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#404030';
      ctx.beginPath();ctx.arc(p.x+1,p.y+1,p.size*0.6,0,Math.PI*2);ctx.fill();
    } else {
      // Arrow
      const angle=Math.atan2(p.ty-p.y,p.tx-p.x);
      ctx.translate(p.x,p.y);ctx.rotate(angle);
      ctx.strokeStyle=p.color;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-8,0);ctx.lineTo(8,0);ctx.stroke();
      ctx.fillStyle=p.color;
      ctx.beginPath();ctx.moveTo(8,0);ctx.lineTo(3,-3);ctx.lineTo(3,3);ctx.closePath();ctx.fill();
    }
    ctx.restore();
  }
}

function drawParticles() {
  for(const p of particles) {
    ctx.globalAlpha=p.alpha;
    ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FLOATING BATTLE TEXT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const battleFloats = [];
function showBattleFloat(x, y, text, color) {
  battleFloats.push({x,y,text,color,life:60,maxLife:60});
}

function drawFloatingTexts(W,H) {
  for(let i=battleFloats.length-1;i>=0;i--) {
    const f=battleFloats[i];
    f.y-=0.8; f.life--;
    if(f.life<=0){battleFloats.splice(i,1);continue;}
    ctx.globalAlpha=f.life/f.maxLife;
    ctx.fillStyle=f.color;
    ctx.font='bold 14px Cinzel,serif';
    ctx.textAlign='center';
    ctx.fillText(f.text,f.x,f.y);
  }
  ctx.globalAlpha=1;
}

// UI floating texts
function showFloatText(x,y,text,color) {
  const el = document.createElement('div');
  el.className='float-txt';
  el.style.left=x+'px';el.style.top=y+'px';
  el.style.color=color;el.style.transform='translate(-50%,-50%)';
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  END BATTLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function endBattle(pStart, eStart, won) {
  const pEnd = battleUnits.filter(u=>u.side==='player'&&!u.dead).length;
  const eEnd = battleUnits.filter(u=>u.side==='enemy'&&!u.dead).length;

  battleHistory.push({level, pStart, eStart, pEnd, eEnd, won});

  document.getElementById('battle-ui').style.display='none';
  gameState='RESULTS';

  if(won) {
    // Update player grid: remove dead units, heal survivors
    const survivors = battleUnits.filter(u=>u.side==='player'&&!u.dead);
    playerGrid = Array.from({length:PLAYER_ROWS},()=>Array(PLAYER_COLS).fill(null));
    for(const s of survivors) {
      const def = PLAYER_UNITS[s.type];
      playerGrid[s.gridRow][s.gridCol] = {type:s.type, hp:def.hp, maxHp:def.hp}; // heal to full
    }
    showResults(true, pStart, eStart, pEnd, eEnd);
  } else {
    // Return to checkpoint
    showResults(false, pStart, eStart, pEnd, eEnd);
  }
}

function showResults(won, pStart, eStart, pEnd, eEnd) {
  const modal = document.getElementById('modal');
  const box = document.getElementById('modal-box');
  modal.classList.add('show');

  const coinsEarned = won ? level * 30 + pEnd * 10 : 0;

  box.innerHTML = `
    <h2>${won ? '‚öîÔ∏è VICTORY!' : 'üíÄ DEFEAT!'}</h2>
    <div class="modal-sub">${won ? `Level ${level} conquered!` : `Your army was defeated...`}</div>
    <canvas id="results-canvas" height="160"></canvas>
    <div class="results-row"><span>Units Started</span><span>${pStart}</span></div>
    <div class="results-row"><span>Enemies Faced</span><span>${eStart}</span></div>
    <div class="results-row"><span>Survivors</span><span style="color:${pEnd>0?'#40f580':'#f54040'}">${pEnd}</span></div>
    ${won ? `<div class="results-row"><span>Coins Earned</span><span style="color:#f5d76e">üí∞ ${coinsEarned}</span></div>` : ''}
    <button class="results-continue" onclick="${won?'proceedAfterWin()':'proceedAfterLoss()'}">
      ${won ? (level>=20 ? 'üèÜ FINAL VICTORY!' : '‚ñ∂ Continue to Shop') : '‚Ü© Return to Checkpoint'}
    </button>
  `;

  if(won) { coins+=coinsEarned; coinDing(); }

  // Draw bar chart
  setTimeout(()=>{
    const rc = document.getElementById('results-canvas');
    if(!rc) return;
    rc.width = rc.offsetWidth;
    const rctx = rc.getContext('2d');
    drawResultsGraph(rctx, rc.width, rc.height, pStart, eStart, pEnd, eEnd, won);
  }, 100);

  updateHUD();
}

function drawResultsGraph(rctx, W, H, pStart, eStart, pEnd, eEnd, won) {
  rctx.fillStyle='#0e0a18';
  rctx.fillRect(0,0,W,H);

  const labels=['Player\nStart','Enemy\nStart','Survivors\n(Player)','Enemies\nLeft'];
  const values=[pStart,eStart,pEnd,eEnd];
  const colors=['#4a8aff','#f54040','#40f580','#ff8a20'];
  const maxVal=Math.max(...values,1);
  const barW=(W-60)/(labels.length*2);
  const chartH=H-40;

  // Axes
  rctx.strokeStyle='#4a2e6a';rctx.lineWidth=1;
  rctx.beginPath();rctx.moveTo(40,10);rctx.lineTo(40,chartH);rctx.lineTo(W-10,chartH);rctx.stroke();

  // Y axis labels
  rctx.fillStyle='#888';rctx.font='10px Cinzel,serif';rctx.textAlign='right';
  for(let i=0;i<=4;i++) {
    const v=Math.round(maxVal*i/4);
    const y=chartH-(chartH-20)*i/4;
    rctx.fillText(v,38,y+3);
    rctx.strokeStyle='#ffffff10';rctx.lineWidth=1;
    rctx.beginPath();rctx.moveTo(40,y);rctx.lineTo(W-10,y);rctx.stroke();
  }

  // Bars
  labels.forEach((label,i) => {
    const x=50+(i*(barW*2)+barW*0.2);
    const bh=((values[i]/maxVal)*(chartH-20));
    const y=chartH-bh;
    const g=rctx.createLinearGradient(0,y,0,chartH);
    g.addColorStop(0,colors[i]);g.addColorStop(1,colors[i]+'44');
    rctx.fillStyle=g;
    rctx.beginPath();rctx.roundRect(x,y,barW*1.6,bh,4);rctx.fill();
    // Value on top
    rctx.fillStyle='#fff';rctx.font='bold 12px Cinzel,serif';rctx.textAlign='center';
    rctx.fillText(values[i],x+barW*0.8,y-4);
    // Label
    rctx.fillStyle='#888';rctx.font='9px Cinzel,serif';
    const parts=label.split('\n');
    parts.forEach((p,pi)=>rctx.fillText(p,x+barW*0.8,chartH+12+pi*11));
  });
}

function proceedAfterWin() {
  document.getElementById('modal').classList.remove('show');
  if(level >= 20) {
    showWinScreen();
    return;
  }
  if(level%5===0) checkpoint=level+1;
  level++;
  startMathShop();
}

function proceedAfterLoss() {
  document.getElementById('modal').classList.remove('show');
  level = checkpoint;
  // Reset to checkpoint ‚Äî give a small coin bonus
  coins += 50;
  playerGrid = Array.from({length:PLAYER_ROWS},()=>Array(PLAYER_COLS).fill(null));
  // Give basic starter units
  setGridUnit(2,0,'swordsman');setGridUnit(2,1,'swordsman');
  setGridUnit(2,2,'spearman');setGridUnit(1,2,'archer');
  setGridUnit(2,3,'swordsman');
  startPlacement();
}

function showWinScreen() {
  const modal=document.getElementById('modal');
  const box=document.getElementById('modal-box');
  modal.classList.add('show');
  box.innerHTML=`
    <div class="game-over-box">
      <h2>üèÜ THE REALM IS SAVED!</h2>
      <p>You have conquered all 20 levels and defeated the Dragon!<br>Your mathematical mastery has brought peace to the kingdom.</p>
      <button class="results-continue" onclick="location.reload()">‚öîÔ∏è Play Again</button>
    </div>`;
  victoryFanfare();
  setTimeout(victoryFanfare,1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  POWER-UP CHALLENGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function requestPowerup(type) {
  if(activePowerups[type]) return;
  const btn=document.getElementById(`pu-${type}`);
  btn.disabled=true;
  powerupPending = type;
  showPowerupChallenge(type, 0, []);
}

function showPowerupChallenge(type, questNum) {
  const modal=document.getElementById('modal');
  const box=document.getElementById('modal-box');
  modal.classList.add('show');
  gameState='POWERUP';

  const names={rally:'‚öîÔ∏è Rally (+35% Attack)',shield:'üõ°Ô∏è Shield Wall (+40% Defense)',medic:'üíö Field Medic (Heal 25%)'};
  const q=generateQuestion();

  box.innerHTML=`
    <h2>${names[type]}</h2>
    <div class="modal-sub">Answer 3 in a row to activate! (${questNum}/3 correct)</div>
    <div class="math-progress">
      ${[0,1,2].map(i=>`<div class="progress-dot ${i<questNum?'done':''}" id="dot-${i}"></div>`).join('')}
    </div>
    <div id="math-question">${q.display}</div>
    <input type="number" id="math-input" placeholder="?" autocomplete="off" inputmode="numeric">
    <button class="math-submit" id="pu-submit-btn">CHECK ‚ñ∂</button>
    <div class="math-feedback" id="math-feedback"></div>
    ${isTouchDevice()?`<div id="numpad">${buildNumpad('puSubmit()')}</div>`:''}
    <button style="margin-top:16px;background:none;border:none;color:#666;font-family:Cinzel,serif;font-size:12px;cursor:pointer;pointer-events:all;" id="pu-cancel-btn">‚úï Cancel</button>
  `;

  box.dataset.question = JSON.stringify(q);
  box.dataset.questNum = questNum;
  box.dataset.type = type;

  document.getElementById('pu-submit-btn').onclick = puSubmit;
  document.getElementById('pu-cancel-btn').onclick = () => cancelPowerup(type);

  const inp=document.getElementById('math-input');
  inp.focus();
  inp.addEventListener('keydown',e=>{if(e.key==='Enter') puSubmit();});
}

function puSubmit() {
  const box=document.getElementById('modal-box');
  const q=JSON.parse(box.dataset.question);
  const questNum=parseInt(box.dataset.questNum);
  const type=box.dataset.type;
  submitPowerupAnswer(q, questNum, type);
}

function submitPowerupAnswer(q, questNum, type) {
  const inp=document.getElementById('math-input');
  const val=parseInt(inp.value);
  if(isNaN(val)){inp.focus();return;}

  const fb=document.getElementById('math-feedback');
  if(val===q.answer) {
    correctSfx();
    fb.textContent='‚úì Correct!';fb.className='math-feedback correct';
    if(questNum+1>=3) {
      setTimeout(()=>{
        activePowerups[type]=true;
        updatePowerupDisplay();
        document.getElementById('modal').classList.remove('show');
        gameState='BATTLE';
        if(type==='medic') {
          battleUnits.forEach(u=>{
            if(u.side==='player'&&!u.dead) u.hp=Math.min(u.hp+Math.round(u.maxHp*0.25),u.maxHp);
          });
        }
      },600);
    } else {
      setTimeout(()=>showPowerupChallenge(type, questNum+1),600);
    }
  } else {
    wrongSfx();
    fb.textContent=`‚úó The answer was ${q.answer}. Start over!`;fb.className='math-feedback wrong';
    setTimeout(()=>showPowerupChallenge(type, 0),800);
  }
}

function cancelPowerup(type) {
  document.getElementById('modal').classList.remove('show');
  const btn=document.getElementById(`pu-${type}`);
  if(btn) btn.disabled=false;
  gameState='BATTLE';
}

function updatePowerupDisplay() {
  const el=document.getElementById('active-powerups');
  el.innerHTML='';
  if(activePowerups.rally) {
    const d=document.createElement('div');
    d.className='active-pu rally';d.textContent='‚öîÔ∏è RALLY ACTIVE';el.appendChild(d);
  }
  if(activePowerups.shield) {
    const d=document.createElement('div');
    d.className='active-pu shield';d.textContent='üõ°Ô∏è SHIELD ACTIVE';el.appendChild(d);
  }
  if(activePowerups.medic) {
    const d=document.createElement('div');
    d.className='active-pu medic';d.textContent='üíö MEDIC ACTIVE';el.appendChild(d);
  }
  // Disable used buttons
  ['rally','shield','medic'].forEach(t=>{
    const btn=document.getElementById(`pu-${t}`);
    if(btn) btn.disabled=activePowerups[t];
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATH SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let shopTimerInterval = null;
let shopCoinsEarned = 0;
let shopTimeLeft = 30;

function startMathShop() {
  gameState='MATHSHOP';
  document.getElementById('hud-phase').textContent='üí∞ MATH SHOP';
  shopCoinsEarned=0;
  shopTimeLeft=30;

  // Render the full modal shell once
  const modal=document.getElementById('modal');
  const box=document.getElementById('modal-box');
  modal.classList.add('show');

  box.innerHTML=`
    <h2>üí∞ Math Shop</h2>
    <div class="modal-sub">Answer to earn coins! Harder = more coins.</div>
    <div id="timer-text">‚è± 30s remaining</div>
    <div id="timer-bar-wrap"><div id="timer-bar" style="width:100%"></div></div>
    <div id="coin-earned">Earned this visit: üí∞ 0</div>
    <div id="math-question"></div>
    <input type="number" id="math-input" placeholder="?" autocomplete="off" inputmode="numeric">
    <button class="math-submit" id="shop-submit">CHECK ‚ñ∂</button>
    <div class="math-feedback" id="math-feedback"></div>
    ${isTouchDevice()?`<div id="numpad">${buildNumpad('shopSubmit()')}</div>`:''}
    <button class="results-continue" style="margin-top:16px;background:linear-gradient(135deg,#2a1a3a,#3a2a5a);border-color:#4a3a7a;color:#a0a0c8;font-size:13px;padding:10px 24px;" onclick="skipShop()">Skip ‚Üí Battle</button>
  `;

  document.getElementById('shop-submit').onclick=shopSubmit;
  const inp=document.getElementById('math-input');
  if(inp) inp.addEventListener('keydown',e=>{if(e.key==='Enter')shopSubmit();});

  // Load first question
  loadNextShopQuestion();

  // Start the single continuous timer
  if(shopTimerInterval) clearInterval(shopTimerInterval);
  shopTimerInterval=setInterval(()=>{
    shopTimeLeft--;
    const tt=document.getElementById('timer-text');
    const tb=document.getElementById('timer-bar');
    if(tt) tt.textContent=`‚è± ${shopTimeLeft}s remaining`;
    if(tb) tb.style.width=`${(shopTimeLeft/30)*100}%`;
    if(shopTimeLeft<=0) { clearInterval(shopTimerInterval); skipShop(); }
  },1000);
}

function loadNextShopQuestion() {
  const q=generateQuestion();
  const coinVal=q.difficulty*5+5;
  const qEl=document.getElementById('math-question');
  if(qEl) qEl.textContent=q.display;
  const fb=document.getElementById('math-feedback');
  if(fb) { fb.textContent=''; fb.className='math-feedback'; }
  const inp=document.getElementById('math-input');
  if(inp) { inp.value=''; inp.focus(); }
  // Store on box for submit to read
  const box=document.getElementById('modal-box');
  box.dataset.question=JSON.stringify(q);
  box.dataset.coinVal=coinVal;
}

function shopSubmit() {
  const box=document.getElementById('modal-box');
  const q=JSON.parse(box.dataset.question);
  const coinVal=parseInt(box.dataset.coinVal);
  const inp=document.getElementById('math-input');
  const val=parseInt(inp.value);
  if(isNaN(val)){inp.focus();return;}

  const fb=document.getElementById('math-feedback');
  if(val===q.answer) {
    correctSfx();
    coins+=coinVal;
    shopCoinsEarned+=coinVal;
    coinDing();
    fb.textContent=`‚úì Correct! +üí∞${coinVal}`;fb.className='math-feedback correct';
    updateHUD();
    document.getElementById('coin-earned').textContent=`Earned this visit: üí∞ ${shopCoinsEarned}`;
    // Brief pause then next question ‚Äî timer keeps running
    setTimeout(loadNextShopQuestion, 700);
  } else {
    wrongSfx();
    fb.textContent=`‚úó The answer was ${q.answer}`;fb.className='math-feedback wrong';
    inp.value='';inp.focus();
  }
}

function skipShop() {
  clearInterval(shopTimerInterval);
  document.getElementById('modal').classList.remove('show');
  updateHUD();
  startPlacement();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATH QUESTION GENERATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateQuestion() {
  // All within 1-12
  const mode=mathMode;
  let a,b,answer,display,difficulty;

  if(mode==='add') {
    // a + ___ = sum  OR  ___ + b = sum
    a=rand(1,12); b=rand(1,12-a);
    const sum=a+b;
    if(Math.random()<0.5) {
      display=`${a} + ___ = ${sum}`; answer=b;
    } else {
      display=`___ + ${b} = ${sum}`; answer=a;
    }
    difficulty=Math.ceil((a+b)/6);
  } else if(mode==='sub') {
    // a - ___ = diff  OR  ___ - b = diff
    a=rand(2,12); b=rand(1,a);
    const diff=a-b;
    if(Math.random()<0.5) {
      display=`${a} ‚àí ___ = ${diff}`; answer=b;
    } else {
      display=`___ ‚àí ${b} = ${diff}`; answer=a;
    }
    difficulty=Math.ceil(a/5);
  } else if(mode==='mul') {
    // a √ó ___ = product  OR  ___ √ó b = product
    a=rand(1,12); b=rand(1,12);
    const prod=a*b;
    if(Math.random()<0.5) {
      display=`${a} √ó ___ = ${prod}`; answer=b;
    } else {
      display=`___ √ó ${b} = ${prod}`; answer=a;
    }
    difficulty=Math.ceil((a+b)/6);
  } else { // div
    // a √∑ ___ = quotient  OR  ___ √∑ b = quotient
    b=rand(1,12); a=rand(1,12);
    const prod=a*b; // dividend
    if(Math.random()<0.5) {
      display=`${prod} √∑ ___ = ${a}`; answer=b; // prod √∑ ___ = a
    } else {
      display=`___ √∑ ${b} = ${a}`; answer=prod; // ___ √∑ b = a
    }
    difficulty=Math.ceil((a+b)/5);
  }
  return {display, answer, difficulty};
}

function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOUCH / NUMPAD HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isTouchDevice(){return 'ontouchstart' in window;}

function buildNumpad(submitFn) {
  const keys=[1,2,3,4,5,6,7,8,9,'‚å´',0,'‚úì'];
  return `<div id="numpad">` +
    keys.map(k=>{
      if(k==='‚å´') return `<button class="num-key del-key" onclick="numpadDel()">‚å´ Delete</button>`;
      if(k==='‚úì') return `<button class="num-key sub-key" onclick="${submitFn}">‚úì GO</button>`;
      return `<button class="num-key" onclick="numpadPress(${k})">${k}</button>`;
    }).join('') + `</div>`;
}

function numpadPress(n) {
  const inp=document.getElementById('math-input');
  if(inp) { inp.value=(inp.value||'')+n; inp.focus(); }
}
function numpadDel() {
  const inp=document.getElementById('math-input');
  if(inp) { inp.value=inp.value.slice(0,-1); inp.focus(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderLoop();

// Prevent right-click
document.addEventListener('contextmenu', e=>e.preventDefault());
// Prevent scroll
document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});
</script>
</body>
</html>
